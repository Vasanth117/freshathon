<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Smart Meter Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --accent-color: #ff7e5f;
            --background-color: #f5f7fa;
            --text-color: #333;
            --card-bg: #fff;
            --border-color: #ddd;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
        }

        .dark-mode {
            --primary-color: #6b8cae;
            --secondary-color: #4a6fa5;
            --accent-color: #ff9a7f;
            --background-color: #121212;
            --text-color: #f0f0f0;
            --card-bg: #1e1e1e;
            --border-color: #444;
            --success-color: #388e3c;
            --warning-color: #f57c00;
            --danger-color: #d32f2f;
            --info-color: #1976d2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: var(--background-color);
        }

        .login-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-size: 24px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-form button:hover {
            background-color: var(--secondary-color);
        }

        .login-footer {
            margin-top: 20px;
            font-size: 14px;
        }

        .login-footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        /* Profile Page Styles */
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin-right: 20px;
        }

        .profile-info h2 {
            margin: 0;
            color: var(--primary-color);
        }

        .profile-info p {
            margin: 5px 0 0;
            color: var(--secondary-color);
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px;
            font-size: 14px;
            color: var(--secondary-color);
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Main Dashboard Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 32px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle, .language-select {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-select {
            background: var(--secondary-color);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .unit {
            color: var(--secondary-color);
            font-size: 14px;
        }

        .trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-top: 5px;
        }

        .trend.up {
            color: var(--danger-color);
        }

        .trend.down {
            color: var(--success-color);
        }

        .trend i {
            margin-right: 5px;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 30px;
            position: relative;
        }

        .chart-container.large {
            height: 400px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button, .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover, .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        button.secondary, .btn.secondary {
            background-color: var(--secondary-color);
        }

        button.danger, .btn.danger {
            background-color: var(--danger-color);
        }

        button.success, .btn.success {
            background-color: var(--success-color);
        }

        button.warning, .btn.warning {
            background-color: var(--warning-color);
        }

        select, input, textarea {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            width: 100%;
            max-width: 300px;
        }

        .alert {
            background-color: var(--warning-color);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s;
        }

        .alert.danger {
            background-color: var(--danger-color);
        }

        .alert.success {
            background-color: var(--success-color);
        }

        .alert.info {
            background-color: var(--info-color);
        }

        .settings-panel {
            display: none;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideDown 0.3s;
        }

        .settings-panel h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .gauge-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .notification-panel {
            position: absolute;
            right: 0;
            top: 40px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .notification-item.unread {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .notification-item .time {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .appliance-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .appliance-card {
            background-color: var(--card-bg);
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .appliance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .appliance-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .appliance-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .appliance-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: var(--success-color);
            color: white;
        }

        .appliance-status.off {
            background-color: var(--danger-color);
        }

        .appliance-power {
            margin-top: 5px;
            font-size: 14px;
        }

        .appliance-slider {
            width: 100%;
            margin-top: 10px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            background-color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

        .history-table tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            background-color: var(--secondary-color);
            color: white;
        }

        .badge.success {
            background-color: var(--success-color);
        }

        .badge.warning {
            background-color: var(--warning-color);
        }

        .badge.danger {
            background-color: var(--danger-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
        }

        .energy-tips {
            margin-top: 30px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
        }

        .energy-tips h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .tip-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .tip-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .tip-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .progress-bar {
            height: 10px;
            border-radius: 10px;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .comparison-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .comparison-card {
            flex: 1;
            min-width: 250px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .comparison-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .comparison-label {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .savings-card {
            background-color: var(--success-color);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .savings-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .savings-label {
            font-size: 16px;
        }

        /* New Styles for Enhanced Features */
        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .user-menu-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .user-menu-dropdown {
            position: absolute;
            right: 0;
            top: 45px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            width: 200px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .user-menu-dropdown.show {
            display: block;
        }

        .user-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .user-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .user-menu-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 5px 0;
        }

        .goals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .goal-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            position: relative;
        }

        .goal-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .goal-progress {
            height: 10px;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            margin: 15px 0;
        }

        .goal-progress-bar {
            height: 100%;
            border-radius: 5px;
            background-color: var(--primary-color);
        }

        .goal-stats {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .goal-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .tariff-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tariff-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }

        .tariff-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .tariff-card.recommended {
            border-color: var(--success-color);
            position: relative;
        }

        .tariff-card.recommended::before {
            content: 'Recommended';
            position: absolute;
            top: -10px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
        }

        .tariff-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .tariff-price {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .tariff-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
        }

        .tariff-features li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tariff-features li::before {
            content: '✓';
            color: var(--success-color);
        }

        .tariff-actions {
            margin-top: 20px;
        }

        /* Forecast Section */
        .forecast-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .forecast-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .forecast-day {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .forecast-icon {
            font-size: 32px;
            margin: 10px 0;
        }

        .forecast-temp {
            font-size: 18px;
            font-weight: bold;
        }

        .forecast-usage {
            margin-top: 10px;
            font-size: 14px;
            color: var(--secondary-color);
        }

        /* Carbon Footprint Section */
        .carbon-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .carbon-value {
            font-size: 36px;
            font-weight: bold;
            margin: 15px 0;
            color: var(--primary-color);
        }

        .carbon-label {
            font-size: 16px;
            color: var(--secondary-color);
        }

        .carbon-equivalent {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-color);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .comparison-container {
                flex-direction: column;
            }

            .notification-panel {
                width: 250px;
                right: -50px;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-avatar {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .profile-stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Icon styles (using Unicode symbols as icons) */
        .icon {
            font-style: normal;
        }
        .icon-bolt:after { content: "⚡"; }
        .icon-sun:after { content: "☀️"; }
        .icon-moon:after { content: "🌙"; }
        .icon-up:after { content: "↑"; }
        .icon-down:after { content: "↓"; }
        .icon-bell:after { content: "🔔"; }
        .icon-settings:after { content: "⚙️"; }
        .icon-chart:after { content: "📊"; }
        .icon-history:after { content: "🕒"; }
        .icon-export:after { content: "📤"; }
        .icon-reset:after { content: "🔄"; }
        .icon-tip:after { content: "💡"; }
        .icon-save:after { content: "💾"; }
        .icon-close:after { content: "✕"; }
        .icon-info:after { content: "ℹ️"; }
        .icon-warning:after { content: "⚠️"; }
        .icon-success:after { content: "✓"; }
        .icon-danger:after { content: "✗"; }
        .icon-ac:after { content: "❄️"; }
        .icon-fridge:after { content: "🍏"; }
        .icon-light:after { content: "💡"; }
        .icon-tv:after { content: "📺"; }
        .icon-other:after { content: "🔌"; }
        .icon-washing:after { content: "🧺"; }
        .icon-computer:after { content: "💻"; }
        .icon-oven:after { content: "🍳"; }
        .icon-user:after { content: "👤"; }
        .icon-logout:after { content: "🚪"; }
        .icon-profile:after { content: "👤"; }
        .icon-goal:after { content: "🎯"; }
        .icon-tariff:after { content: "💰"; }
        .icon-cloud:after { content: "☁️"; }
        .icon-sunny:after { content: "☀️"; }
        .icon-rain:after { content: "🌧️"; }
        .icon-co2:after { content: "🌱"; }
    </style>
</head>
<body>
    <!-- Login Page (Initially visible) -->
    <div class="login-container" id="loginPage">
        <div class="login-card">
            <h1>Smart Meter Login</h1>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <div class="login-footer">
                <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
            </div>
        </div>
    </div>

    <!-- Registration Page (Hidden initially) -->
    <div class="login-container" id="registerPage" style="display: none;">
        <div class="login-card">
            <h1>Create Account</h1>
            <form class="login-form" id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" placeholder="Confirm your password" required>
                </div>
                <button type="submit" class="btn">Register</button>
            </form>
            <div class="login-footer">
                <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard (Hidden initially) -->
    <div class="container" id="dashboard" style="display: none;">
        <header>
            <div class="logo">
                <span class="icon icon-bolt"></span>
                <span>Advanced Smart Meter</span>
            </div>
            <div class="header-controls">
                <div class="notification-bell" id="notificationBell">
                    <span class="icon icon-bell"></span>
                    <span class="notification-badge" id="notificationBadge">0</span>
                    <div class="notification-panel" id="notificationPanel"></div>
                </div>
                <select class="language-select" id="languageSelect">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                    <option value="fr">Français</option>
                    <option value="de">Deutsch</option>
                </select>
                <button id="themeToggle" class="theme-toggle">
                    <span class="icon icon-sun"></span>
                    <span>Light Mode</span>
                </button>
                <div class="user-menu">
                    <button class="user-menu-btn" id="userMenuBtn">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="userName">User</span>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-menu-item" id="profileBtn">
                            <span class="icon icon-profile"></span>
                            <span>Profile</span>
                        </div>
                        <div class="user-menu-item" id="settingsBtn">
                            <span class="icon icon-settings"></span>
                            <span>Settings</span>
                        </div>
                        <div class="user-menu-divider"></div>
                        <div class="user-menu-item" id="logoutBtn">
                            <span class="icon icon-logout"></span>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Profile Section (Hidden initially) -->
        <div id="profileSection" style="display: none;">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">U</div>
                <div class="profile-info">
                    <h2 id="profileName">User Name</h2>
                    <p id="profileEmail">user@example.com</p>
                </div>
            </div>

            <div class="profile-stats">
                <div class="stat-card">
                    <h3>Member Since</h3>
                    <div class="value" id="memberSince">2023</div>
                </div>
                <div class="stat-card">
                    <h3>Total Savings</h3>
                    <div class="value" id="totalSavings">₹1,250</div>
                </div>
                <div class="stat-card">
                    <h3>Efficiency Score</h3>
                    <div class="value" id="efficiencyScore">82%</div>
                </div>
                <div class="stat-card">
                    <h3>Carbon Saved</h3>
                    <div class="value" id="carbonSaved">450 kg</div>
                </div>
            </div>

            <button class="btn" id="editProfileBtn">
                <span class="icon icon-save"></span>
                <span>Edit Profile</span>
            </button>

            <div class="tabs">
                <div class="tab active" data-tab="profileUsage">Usage History</div>
                <div class="tab" data-tab="profileGoals">Goals</div>
                <div class="tab" data-tab="profileTariffs">Tariffs</div>
            </div>

            <div class="tab-content active" id="profileUsageTab">
                <div class="chart-container large">
                    <canvas id="profileUsageChart"></canvas>
                </div>
                <div class="controls">
                    <button id="profileViewYearBtn" class="secondary">
                        <span class="icon icon-history"></span>
                        <span>Year</span>
                    </button>
                    <button id="profileViewAllBtn" class="secondary">
                        <span class="icon icon-chart"></span>
                        <span>All Time</span>
                    </button>
                </div>
            </div>

            <div class="tab-content" id="profileGoalsTab">
                <div class="goals-container" id="goalsContainer">
                    <!-- Goals will be added here dynamically -->
                </div>
                <button class="btn" id="addGoalBtn">
                    <span class="icon icon-goal"></span>
                    <span>Add New Goal</span>
                </button>
            </div>

            <div class="tab-content" id="profileTariffsTab">
                <div class="tariff-plans" id="tariffPlans">
                    <!-- Tariff plans will be added here dynamically -->
                </div>
                <div class="alert info">
                    <span class="icon icon-info"></span>
                    <span>Your current plan: <strong id="currentTariffPlan">Standard</strong></span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Section -->
        <div id="mainDashboard">
            <div class="alert" id="budgetAlert">
                <span class="icon icon-warning"></span>
                <span id="budgetAlertText">Warning: You've exceeded your budget limit!</span>
            </div>

            <div class="alert info" id="peakAlert" style="display: none;">
                <span class="icon icon-info"></span>
                <span id="peakAlertText">Peak hours alert: Higher rates apply now (2pm-7pm). Consider reducing usage.</span>
            </div>

            <!-- Weather Forecast Section -->
            <div class="forecast-container" id="weatherForecast">
                <!-- Forecast cards will be added here dynamically -->
            </div>

            <!-- Carbon Footprint Section -->
            <div class="carbon-card">
                <h2><span class="icon icon-co2"></span> Your Carbon Footprint</h2>
                <div class="carbon-value" id="carbonFootprint">1.2</div>
                <div class="carbon-label">kg CO2 per kWh</div>
                <div class="carbon-equivalent">
                    Equivalent to <span id="carbonEquivalent">driving 5 km</span> in a petrol car
                </div>
                <button class="btn secondary" id="learnMoreCarbonBtn" style="margin-top: 15px;">
                    <span class="icon icon-info"></span>
                    <span>Learn How to Reduce</span>
                </button>
            </div>

            <div class="dashboard">
                <div class="card">
                    <h2><span class="icon icon-bolt"></span> Current Usage</h2>
                    <div class="value" id="currentUsage">0</div>
                    <div class="unit">kWh</div>
                    <div class="trend" id="usageTrend">
                        <span class="icon icon-up"></span>
                        <span id="trendValue">0%</span> from yesterday
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon icon-chart"></span> Estimated Bill</h2>
                    <div class="value" id="estimatedBill">₹0</div>
                    <div class="unit">Current rate: <span id="rateDisplay">₹5</span>/kWh</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="budgetProgress"></div>
                    </div>
                    <div class="unit">Budget: ₹<span id="budgetLimitDisplay">1000</span>/<span id="budgetCycleDisplay">month</span></div>
                </div>
                <div class="card">
                    <h2><span class="icon icon-history"></span> Daily Average</h2>
                    <div class="value" id="dailyAverage">0</div>
                    <div class="unit">kWh/day</div>
                    <div class="trend down" id="savingsTrend">
                        <span class="icon icon-down"></span>
                        <span id="savingsValue">0%</span> less than last month
                    </div>
                </div>
                <div class="card">
                    <h2><span class="icon icon-tip"></span> Potential Savings</h2>
                    <div class="value" id="potentialSavings">₹0</div>
                    <div class="unit">per month with efficiency</div>
                    <button class="btn secondary" id="savingsTipBtn" style="margin-top: 10px;">
                        <span class="icon icon-tip"></span>
                        <span>Show Tips</span>
                    </button>
                </div>
            </div>

            <div class="gauge-container">
                <canvas id="gaugeChart"></canvas>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="usage">Usage Analytics</div>
                <div class="tab" data-tab="appliances">Appliances</div>
                <div class="tab" data-tab="history">History</div>
                <div class="tab" data-tab="comparison">Comparison</div>
                <div class="tab" data-tab="forecast">Forecast</div>
            </div>

            <div class="tab-content active" id="usageTab">
                <div class="chart-container large">
                    <canvas id="usageChart"></canvas>
                </div>
                <div class="controls">
                    <button id="viewDayBtn" class="secondary">
                        <span class="icon icon-sun"></span>
                        <span>Day</span>
                    </button>
                    <button id="viewWeekBtn" class="secondary">
                        <span class="icon icon-history"></span>
                        <span>Week</span>
                    </button>
                    <button id="viewMonthBtn" class="secondary">
                        <span class="icon icon-chart"></span>
                        <span>Month</span>
                    </button>
                    <select id="timeResolution">
                        <option value="hourly">Hourly</option>
                        <option value="30min">30 Minutes</option>
                        <option value="15min">15 Minutes</option>
                    </select>
                </div>
            </div>

            <div class="tab-content" id="appliancesTab">
                <div class="appliance-controls" id="applianceControls">
                    <!-- Dynamically generated -->
                </div>
                <div class="chart-container">
                    <canvas id="applianceChart"></canvas>
                </div>
                <button class="btn" id="addApplianceBtn">
                    <span class="icon icon-save"></span>
                    <span>Add Custom Appliance</span>
                </button>
            </div>

            <div class="tab-content" id="historyTab">
                <div class="controls">
                    <select id="historyRange">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="90">Last 90 Days</option>
                        <option value="365">Last Year</option>
                    </select>
                    <button class="btn secondary" id="exportHistoryBtn">
                        <span class="icon icon-export"></span>
                        <span>Export History</span>
                    </button>
                </div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Usage (kWh)</th>
                            <th>Cost (₹)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Dynamically generated -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="comparisonTab">
                <div class="comparison-container">
                    <div class="comparison-card">
                        <div class="comparison-label">Your Usage</div>
                        <div class="comparison-value" id="yourUsage">0 kWh</div>
                        <div class="comparison-label">Today</div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-label">Neighborhood Avg</div>
                        <div class="comparison-value" id="neighborUsage">0 kWh</div>
                        <div class="comparison-label">Today</div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-label">Efficient Homes</div>
                        <div class="comparison-value" id="efficientUsage">0 kWh</div>
                        <div class="comparison-label">Today</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <div class="savings-card">
                    <div class="savings-label">Potential Savings Compared to Neighbors</div>
                    <div class="savings-value" id="neighborSavings">₹0</div>
                    <div class="savings-label">per month if you match efficient homes</div>
                </div>
            </div>

            <div class="tab-content" id="forecastTab">
                <div class="chart-container large">
                    <canvas id="forecastChart"></canvas>
                </div>
                <div class="controls">
                    <button id="forecastDayBtn" class="secondary">
                        <span class="icon icon-sun"></span>
                        <span>Next 24 Hours</span>
                    </button>
                    <button id="forecastWeekBtn" class="secondary">
                        <span class="icon icon-history"></span>
                        <span>Next 7 Days</span>
                    </button>
                </div>
                <div class="energy-tips">
                    <h2><span class="icon icon-tip"></span> Forecast Tips</h2>
                    <div class="tip-item">
                        <div class="tip-title"><span class="icon icon-sunny"></span> Sunny Tomorrow</div>
                        <p>Consider using solar panels to reduce grid consumption during daylight hours.</p>
                    </div>
                    <div class="tip-item">
                        <div class="tip-title"><span class="icon icon-rain"></span> Rain Expected</div>
                        <p>Higher humidity may increase AC usage. Set your thermostat 1-2° higher to compensate.</p>
                    </div>
                </div>
            </div>

            <div class="settings-panel" id="settingsPanel">
                <h2><span class="icon icon-settings"></span> Settings</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="rateInput">Electricity Rate (₹/kWh)</label>
                        <input type="number" id="rateInput" step="0.01" min="0" value="5">
                    </div>
                    <div class="form-group">
                        <label for="budgetInput">Budget Limit (₹)</label>
                        <input type="number" id="budgetInput" min="0" value="1000">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cycleInput">Billing Cycle</label>
                        <select id="cycleInput">
                            <option value="7">Weekly</option>
                            <option value="15">Bi-weekly</option>
                            <option value="30" selected>Monthly</option>
                            <option value="60">Bi-monthly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="peakRateInput">Peak Hours Rate (₹/kWh)</label>
                        <input type="number" id="peakRateInput" step="0.01" min="0" value="7.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="peakStart">Peak Hours Start</label>
                        <input type="time" id="peakStart" value="14:00">
                    </div>
                    <div class="form-group">
                        <label for="peakEnd">Peak Hours End</label>
                        <input type="time" id="peakEnd" value="19:00">
                    </div>
                </div>
                <div class="form-group">
                    <label for="fontSlider">Font Size</label>
                    <input type="range" id="fontSlider" min="12" max="24" value="16">
                </div>
                <div class="form-group">
                    <label for="notifications">Notifications</label>
                    <div>
                        <input type="checkbox" id="budgetAlertCheck" checked>
                        <label for="budgetAlertCheck" style="display: inline;">Budget alerts</label>
                    </div>
                    <div>
                        <input type="checkbox" id="peakAlertCheck" checked>
                        <label for="peakAlertCheck" style="display: inline;">Peak hours alerts</label>
                    </div>
                    <div>
                        <input type="checkbox" id="speechCheck">
                        <label for="speechCheck" style="display: inline;">Voice notifications</label>
                    </div>
                </div>
                <button id="saveSettings" class="btn success">
                    <span class="icon icon-save"></span>
                    <span>Save Settings</span>
                </button>
            </div>

            <div class="energy-tips" id="energyTipsPanel" style="display: none;">
                <h2><span class="icon icon-tip"></span> Energy Saving Tips</h2>
                <div class="tip-item">
                    <div class="tip-title"><span class="icon icon-ac"></span> Air Conditioning</div>
                    <p>Set your AC to 24°C instead of 20°C to save up to 18% on cooling costs.</p>
                </div>
                <div class="tip-item">
                    <div class="tip-title"><span class="icon icon-light"></span> Lighting</div>
                    <p>Switch to LED bulbs which use 75% less energy than incandescent bulbs.</p>
                </div>
                <div class="tip-item">
                    <div class="tip-title"><span class="icon icon-fridge"></span> Refrigerator</div>
                    <p>Keep your fridge at 3-5°C and freezer at -15°C for optimal efficiency.</p>
                </div>
                <div class="tip-item">
                    <div class="tip-title"><span class="icon icon-tv"></span> Electronics</div>
                    <p>Enable power saving modes on TVs and computers to reduce standby power.</p>
                </div>
                <button class="btn" id="closeTipsBtn" style="margin-top: 15px;">
                    <span class="icon icon-close"></span>
                    <span>Close Tips</span>
                </button>
            </div>

            <div class="modal" id="addApplianceModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Add Custom Appliance</div>
                        <div class="modal-close icon icon-close" id="closeApplianceModal"></div>
                    </div>
                    <div class="form-group">
                        <label for="applianceName">Appliance Name</label>
                        <input type="text" id="applianceName" placeholder="e.g., Washing Machine">
                    </div>
                    <div class="form-group">
                        <label for="applianceWattage">Wattage (W)</label>
                        <input type="number" id="applianceWattage" placeholder="e.g., 500">
                    </div>
                    <div class="form-group">
                        <label for="applianceUsage">Daily Usage (hours)</label>
                        <input type="number" id="applianceUsage" placeholder="e.g., 2" step="0.5">
                    </div>
                    <button class="btn success" id="saveApplianceBtn">
                        <span class="icon icon-save"></span>
                        <span>Save Appliance</span>
                    </button>
                </div>
            </div>

            <div class="modal" id="addGoalModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Add New Goal</div>
                        <div class="modal-close icon icon-close" id="closeGoalModal"></div>
                    </div>
                    <div class="form-group">
                        <label for="goalName">Goal Name</label>
                        <input type="text" id="goalName" placeholder="e.g., Reduce AC Usage">
                    </div>
                    <div class="form-group">
                        <label for="goalTarget">Target Reduction (%)</label>
                        <input type="number" id="goalTarget" placeholder="e.g., 15" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="goalTimeframe">Timeframe</label>
                        <select id="goalTimeframe">
                            <option value="7">1 Week</option>
                            <option value="30" selected>1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="365">1 Year</option>
                        </select>
                    </div>
                    <button class="btn success" id="saveGoalBtn">
                        <span class="icon icon-save"></span>
                        <span>Save Goal</span>
                    </button>
                </div>
            </div>

            <div class="modal" id="editProfileModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Edit Profile</div>
                        <div class="modal-close icon icon-close" id="closeProfileModal"></div>
                    </div>
                    <div class="form-group">
                        <label for="editProfileName">Full Name</label>
                        <input type="text" id="editProfileName" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="editProfileEmail">Email</label>
                        <input type="email" id="editProfileEmail" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="editProfilePassword">New Password (leave blank to keep current)</label>
                        <input type="password" id="editProfilePassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label for="editProfileConfirmPassword">Confirm New Password</label>
                        <input type="password" id="editProfileConfirmPassword" placeholder="Confirm new password">
                    </div>
                    <button class="btn success" id="saveProfileBtn">
                        <span class="icon icon-save"></span>
                        <span>Save Changes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Safe DOM element selector with error handling
        function getElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Element with ID '${id}' not found`);
                return null;
            }
            return element;
        }

        // Safe event listener adder
        function addSafeListener(element, event, handler) {
            if (!element) return;
            element.addEventListener(event, handler);
        }

        // DOM Elements
        const elements = {
            // Login/Register elements
            loginPage: getElement('loginPage'),
            registerPage: getElement('registerPage'),
            loginForm: getElement('loginForm'),
            registerForm: getElement('registerForm'),
            showRegister: getElement('showRegister'),
            showLogin: getElement('showLogin'),
            loginEmail: getElement('loginEmail'),
            loginPassword: getElement('loginPassword'),
            registerName: getElement('registerName'),
            registerEmail: getElement('registerEmail'),
            registerPassword: getElement('registerPassword'),
            registerConfirmPassword: getElement('registerConfirmPassword'),
            
            // Dashboard elements
            dashboard: getElement('dashboard'),
            mainDashboard: getElement('mainDashboard'),
            profileSection: getElement('profileSection'),
            currentUsage: getElement('currentUsage'),
            estimatedBill: getElement('estimatedBill'),
            budgetProgress: getElement('budgetProgress'),
            rateDisplay: getElement('rateDisplay'),
            budgetLimitDisplay: getElement('budgetLimitDisplay'),
            budgetCycleDisplay: getElement('budgetCycleDisplay'),
            budgetAlert: getElement('budgetAlert'),
            budgetAlertText: getElement('budgetAlertText'),
            peakAlert: getElement('peakAlert'),
            peakAlertText: getElement('peakAlertText'),
            dailyAverage: getElement('dailyAverage'),
            potentialSavings: getElement('potentialSavings'),
            usageTrend: getElement('usageTrend'),
            trendValue: getElement('trendValue'),
            savingsTrend: getElement('savingsTrend'),
            savingsValue: getElement('savingsValue'),
            themeToggle: getElement('themeToggle'),
            settingsBtn: getElement('settingsBtn'),
            resetBtn: getElement('resetBtn'),
            exportBtn: getElement('exportBtn'),
            viewSelect: getElement('viewSelect'),
            settingsPanel: getElement('settingsPanel'),
            rateInput: getElement('rateInput'),
            budgetInput: getElement('budgetInput'),
            cycleInput: getElement('cycleInput'),
            peakRateInput: getElement('peakRateInput'),
            peakStart: getElement('peakStart'),
            peakEnd: getElement('peakEnd'),
            fontSlider: getElement('fontSlider'),
            saveSettings: getElement('saveSettings'),
            notificationBell: getElement('notificationBell'),
            notificationBadge: getElement('notificationBadge'),
            notificationPanel: getElement('notificationPanel'),
            viewDayBtn: getElement('viewDayBtn'),
            viewWeekBtn: getElement('viewWeekBtn'),
            viewMonthBtn: getElement('viewMonthBtn'),
            timeResolution: getElement('timeResolution'),
            applianceControls: getElement('applianceControls'),
            addApplianceBtn: getElement('addApplianceBtn'),
            historyRange: getElement('historyRange'),
            exportHistoryBtn: getElement('exportHistoryBtn'),
            historyTableBody: getElement('historyTableBody'),
            yourUsage: getElement('yourUsage'),
            neighborUsage: getElement('neighborUsage'),
            efficientUsage: getElement('efficientUsage'),
            neighborSavings: getElement('neighborSavings'),
            savingsTipBtn: getElement('savingsTipBtn'),
            energyTipsPanel: getElement('energyTipsPanel'),
            closeTipsBtn: getElement('closeTipsBtn'),
            addApplianceModal: getElement('addApplianceModal'),
            closeApplianceModal: getElement('closeApplianceModal'),
            applianceName: getElement('applianceName'),
            applianceWattage: getElement('applianceWattage'),
            applianceUsage: getElement('applianceUsage'),
            saveApplianceBtn: getElement('saveApplianceBtn'),
            budgetAlertCheck: getElement('budgetAlertCheck'),
            peakAlertCheck: getElement('peakAlertCheck'),
            speechCheck: getElement('speechCheck'),
            languageSelect: getElement('languageSelect'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // User profile elements
            userMenuBtn: getElement('userMenuBtn'),
            userMenuDropdown: getElement('userMenuDropdown'),
            userAvatar: getElement('userAvatar'),
            userName: getElement('userName'),
            profileBtn: getElement('profileBtn'),
            logoutBtn: getElement('logoutBtn'),
            profileAvatar: getElement('profileAvatar'),
            profileName: getElement('profileName'),
            profileEmail: getElement('profileEmail'),
            memberSince: getElement('memberSince'),
            totalSavings: getElement('totalSavings'),
            efficiencyScore: getElement('efficiencyScore'),
            carbonSaved: getElement('carbonSaved'),
            editProfileBtn: getElement('editProfileBtn'),
            profileViewYearBtn: getElement('profileViewYearBtn'),
            profileViewAllBtn: getElement('profileViewAllBtn'),
            goalsContainer: getElement('goalsContainer'),
            addGoalBtn: getElement('addGoalBtn'),
            tariffPlans: getElement('tariffPlans'),
            currentTariffPlan: getElement('currentTariffPlan'),
            
            // Modal elements
            addGoalModal: getElement('addGoalModal'),
            closeGoalModal: getElement('closeGoalModal'),
            goalName: getElement('goalName'),
            goalTarget: getElement('goalTarget'),
            goalTimeframe: getElement('goalTimeframe'),
            saveGoalBtn: getElement('saveGoalBtn'),
            editProfileModal: getElement('editProfileModal'),
            closeProfileModal: getElement('closeProfileModal'),
            editProfileName: getElement('editProfileName'),
            editProfileEmail: getElement('editProfileEmail'),
            editProfilePassword: getElement('editProfilePassword'),
            editProfileConfirmPassword: getElement('editProfileConfirmPassword'),
            saveProfileBtn: getElement('saveProfileBtn'),
            
            // New feature elements
            weatherForecast: getElement('weatherForecast'),
            carbonFootprint: getElement('carbonFootprint'),
            carbonEquivalent: getElement('carbonEquivalent'),
            learnMoreCarbonBtn: getElement('learnMoreCarbonBtn'),
            forecastTab: getElement('forecastTab'),
            forecastChart: document.getElementById('forecastChart')?.getContext('2d'),
            forecastDayBtn: getElement('forecastDayBtn'),
            forecastWeekBtn: getElement('forecastWeekBtn')
        };

        // State
        let state = {
            currentUser: null,
            users: {},
            currentUsage: 0,
            totalUsage: 0,
            rate: 5,
            peakRate: 7.5,
            peakStart: 14,
            peakEnd: 19,
            budget: 1000,
            cycleDays: 30,
            daysRemaining: 30,
            darkMode: false,
            usageHistory: {},
            hourlyHistory: Array(24).fill(0),
            dailyHistory: [],
            applianceUsage: {
                'AC': { usage: 0, wattage: 2000, active: false, icon: 'icon-ac' },
                'Refrigerator': { usage: 0, wattage: 150, active: true, icon: 'icon-fridge' },
                'Lights': { usage: 0, wattage: 100, active: false, icon: 'icon-light' },
                'TV': { usage: 0, wattage: 120, active: false, icon: 'icon-tv' },
                'Other': { usage: 0, wattage: 500, active: false, icon: 'icon-other' }
            },
            customAppliances: {},
            lastUpdate: Date.now(),
            yesterdayUsage: 0,
            lastMonthUsage: 0,
            notifications: [],
            currentTab: 'usage',
            currentView: 'day',
            language: 'en',
            translations: {
                en: {
                    budgetAlert: "Warning: You've exceeded your budget limit!",
                    peakAlert: "Peak hours alert: Higher rates apply now (2pm-7pm). Consider reducing usage.",
                    lightMode: "Light Mode",
                    darkMode: "Dark Mode",
                    currentUsage: "Current Usage",
                    estimatedBill: "Estimated Bill",
                    dailyAverage: "Daily Average",
                    potentialSavings: "Potential Savings",
                    usage: "Usage Analytics",
                    appliances: "Appliances",
                    history: "History",
                    comparison: "Comparison",
                    forecast: "Forecast",
                    loginTitle: "Smart Meter Login",
                    registerTitle: "Create Account",
                    memberSince: "Member Since",
                    totalSavings: "Total Savings",
                    efficiencyScore: "Efficiency Score",
                    carbonSaved: "Carbon Saved",
                    editProfile: "Edit Profile",
                    logout: "Logout",
                    settings: "Settings",
                    profile: "Profile"
                },
                es: {
                    budgetAlert: "¡Advertencia: Ha excedido su límite de presupuesto!",
                    peakAlert: "Alerta de horas pico: Se aplican tarifas más altas ahora (2pm-7pm). Considere reducir el uso.",
                    lightMode: "Modo Claro",
                    darkMode: "Modo Oscuro",
                    currentUsage: "Uso Actual",
                    estimatedBill: "Factura Estimada",
                    dailyAverage: "Promedio Diario",
                    potentialSavings: "Ahorros Potenciales",
                    usage: "Análisis de Uso",
                    appliances: "Electrodomésticos",
                    history: "Historial",
                    comparison: "Comparación",
                    forecast: "Pronóstico",
                    loginTitle: "Inicio de Sesión",
                    registerTitle: "Crear Cuenta",
                    memberSince: "Miembro Desde",
                    totalSavings: "Ahorros Totales",
                    efficiencyScore: "Puntuación de Eficiencia",
                    carbonSaved: "Carbono Ahorrado",
                    editProfile: "Editar Perfil",
                    logout: "Cerrar Sesión",
                    settings: "Configuración",
                    profile: "Perfil"
                },
                fr: {
                    budgetAlert: "Avertissement : Vous avez dépassé votre limite de budget !",
                    peakAlert: "Alerte heures de pointe : Des tarifs plus élevés s'appliquent maintenant (14h-19h). Envisagez de réduire l'utilisation.",
                    lightMode: "Mode Clair",
                    darkMode: "Mode Sombre",
                    currentUsage: "Utilisation Actuelle",
                    estimatedBill: "Facture Estimée",
                    dailyAverage: "Moyenne Quotidienne",
                    potentialSavings: "Économies Potentielles",
                    usage: "Analyse d'Utilisation",
                    appliances: "Appareils",
                    history: "Historique",
                    comparison: "Comparaison",
                    forecast: "Prévision",
                    loginTitle: "Connexion",
                    registerTitle: "Créer un Compte",
                    memberSince: "Membre Depuis",
                    totalSavings: "Économies Totales",
                    efficiencyScore: "Score d'Efficacité",
                    carbonSaved: "Carbone Économisé",
                    editProfile: "Modifier le Profil",
                    logout: "Déconnexion",
                    settings: "Paramètres",
                    profile: "Profil"
                },
                de: {
                    budgetAlert: "Warnung: Sie haben Ihr Budgetlimit überschritten!",
                    peakAlert: "Spitzenzeiten-Warnung: Höhere Tarife gelten jetzt (14-19 Uhr). Erwägen Sie, den Verbrauch zu reduzieren.",
                    lightMode: "Hellmodus",
                    darkMode: "Dunkelmodus",
                    currentUsage: "Aktueller Verbrauch",
                    estimatedBill: "Geschätzte Rechnung",
                    dailyAverage: "Tagesdurchschnitt",
                    potentialSavings: "Potenzielle Einsparungen",
                    usage: "Verbrauchsanalyse",
                    appliances: "Geräte",
                    history: "Verlauf",
                    comparison: "Vergleich",
                    forecast: "Vorhersage",
                    loginTitle: "Anmeldung",
                    registerTitle: "Konto Erstellen",
                    memberSince: "Mitglied Seit",
                    totalSavings: "Gesamtersparnis",
                    efficiencyScore: "Effizienz-Score",
                    carbonSaved: "CO2-Einsparung",
                    editProfile: "Profil Bearbeiten",
                    logout: "Abmelden",
                    settings: "Einstellungen",
                    profile: "Profil"
                }
            },
            goals: [
                { id: 1, name: "Reduce AC Usage", target: 20, current: 12, timeframe: 30, unit: "%" },
                { id: 2, name: "Monthly Budget", target: 1000, current: 850, timeframe: 30, unit: "₹" },
                { id: 3, name: "Daily Average", target: 5, current: 6.2, timeframe: 30, unit: "kWh" }
            ],
            tariffPlans: [
                { 
                    id: 1, 
                    name: "Basic", 
                    price: "₹4.50/kWh", 
                    features: ["Standard rates", "Basic usage tracking", "Email support"],
                    recommended: false
                },
                { 
                    id: 2, 
                    name: "Standard", 
                    price: "₹5.00/kWh", 
                    features: ["Peak/off-peak rates", "Advanced analytics", "24/7 support"],
                    recommended: true,
                    current: true
                },
                { 
                    id: 3, 
                    name: "Premium", 
                    price: "₹5.50/kWh", 
                    features: ["Lower peak rates", "Priority support", "Solar integration", "Energy forecasts"],
                    recommended: false
                }
            ],
            weatherForecast: [
                { day: "Today", icon: "icon-sunny", temp: "32°C", usage: "6.2 kWh" },
                { day: "Tomorrow", icon: "icon-sunny", temp: "33°C", usage: "6.5 kWh" },
                { day: "Wed", icon: "icon-cloud", temp: "30°C", usage: "5.8 kWh" },
                { day: "Thu", icon: "icon-rain", temp: "28°C", usage: "6.1 kWh" },
                { day: "Fri", icon: "icon-cloud", temp: "29°C", usage: "5.9 kWh" }
            ],
            carbonData: {
                footprint: 1.2,
                equivalent: "driving 5 km",
                saved: 450
            }
        };

        // Initialize charts
        let usageChart, applianceChart, gaugeChart, comparisonChart, profileUsageChart, forecastChart;

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('smartMeterState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                
                // Merge with default state to ensure new properties are added
                state = {
                    ...state,
                    ...parsed,
                    lastUpdate: Date.now(), // Reset last update time
                    applianceUsage: {
                        ...state.applianceUsage,
                        ...(parsed.applianceUsage || {})
                    }
                };
                
                // Update UI with loaded values
                if (elements.rateInput) elements.rateInput.value = state.rate;
                if (elements.budgetInput) elements.budgetInput.value = state.budget;
                if (elements.cycleInput) elements.cycleInput.value = state.cycleDays;
                if (elements.peakRateInput) elements.peakRateInput.value = state.peakRate;
                if (elements.peakStart) elements.peakStart.value = `${state.peakStart.toString().padStart(2, '0')}:00`;
                if (elements.peakEnd) elements.peakEnd.value = `${state.peakEnd.toString().padStart(2, '0')}:00`;
                if (elements.budgetAlertCheck) elements.budgetAlertCheck.checked = state.notifications?.budgetAlerts !== false;
                if (elements.peakAlertCheck) elements.peakAlertCheck.checked = state.notifications?.peakAlerts !== false;
                if (elements.speechCheck) elements.speechCheck.checked = state.notifications?.speech === true;
                if (elements.languageSelect) elements.languageSelect.value = state.language || 'en';
                
                if (state.darkMode) {
                    document.body.classList.add('dark-mode');
                    if (elements.themeToggle) {
                        elements.themeToggle.innerHTML = `<span class="icon icon-moon"></span><span>${state.translations[state.language].darkMode}</span>`;
                    }
                } else if (elements.themeToggle) {
                    elements.themeToggle.innerHTML = `<span class="icon icon-sun"></span><span>${state.translations[state.language].lightMode}</span>`;
                }

                // Load users if any
                const savedUsers = localStorage.getItem('smartMeterUsers');
                if (savedUsers) {
                    state.users = JSON.parse(savedUsers);
                }

                // Check if user is logged in
                const loggedInUser = localStorage.getItem('smartMeterCurrentUser');
                if (loggedInUser && state.users[loggedInUser]) {
                    state.currentUser = loggedInUser;
                    showDashboard();
                    updateUserProfile();
                }

                updateUI();
                updateNotifications();
                translateUI();
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('smartMeterState', JSON.stringify({
                ...state,
                lastUpdate: Date.now() // Don't save the lastUpdate to storage
            }));
            
            // Save users separately
            localStorage.setItem('smartMeterUsers', JSON.stringify(state.users));
            
            // Save current user if logged in
            if (state.currentUser) {
                localStorage.setItem('smartMeterCurrentUser', state.currentUser);
            }
        }

        // Initialize charts
        function initCharts() {
            // Usage chart (line)
            const usageCtx = document.getElementById('usageChart')?.getContext('2d');
            if (usageCtx) {
                usageChart = new Chart(usageCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Electricity Usage (kWh)',
                            data: [],
                            borderColor: 'rgba(74, 111, 165, 1)',
                            backgroundColor: 'rgba(74, 111, 165, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'HH:mm'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'kWh'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        }
                    }
                });
            }

            // Appliance chart (doughnut)
            const applianceCtx = document.getElementById('applianceChart')?.getContext('2d');
            if (applianceCtx) {
                applianceChart = new Chart(applianceCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(state.applianceUsage),
                        datasets: [{
                            data: Object.values(state.applianceUsage).map(a => a.usage),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            // Gauge chart
            const gaugeCtx = document.getElementById('gaugeChart')?.getContext('2d');
            if (gaugeCtx) {
                gaugeChart = new Chart(gaugeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Used', 'Remaining'],
                        datasets: [{
                            data: [0, 100],
                            backgroundColor: [
                                'rgba(244, 67, 54, 0.7)',
                                'rgba(76, 175, 80, 0.7)'
                            ],
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        circumference: 180,
                        rotation: 270,
                        cutout: '80%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        }
                    }
                });
            }

            // Comparison chart (bar)
            const comparisonCtx = document.getElementById('comparisonChart')?.getContext('2d');
            if (comparisonCtx) {
                comparisonChart = new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Your Home', 'Neighborhood Avg', 'Efficient Homes'],
                        datasets: [{
                            label: 'Daily Usage (kWh)',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(74, 111, 165, 0.7)',
                                'rgba(169, 169, 169, 0.7)',
                                'rgba(76, 175, 80, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Profile usage chart (line)
            const profileUsageCtx = document.getElementById('profileUsageChart')?.getContext('2d');
            if (profileUsageCtx) {
                profileUsageChart = new Chart(profileUsageCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Monthly Usage (kWh)',
                            data: [],
                            borderColor: 'rgba(74, 111, 165, 1)',
                            backgroundColor: 'rgba(74, 111, 165, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: {
                                        month: 'MMM YYYY'
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Forecast chart (line)
            if (elements.forecastChart) {
                forecastChart = new Chart(elements.forecastChart, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'Temperature (°C)',
                                data: [],
                                borderColor: 'rgba(255, 159, 64, 1)',
                                backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                borderWidth: 2,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Expected Usage (kWh)',
                                data: [],
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                borderWidth: 2,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Usage (kWh)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
        }

        // Update charts with current data
        function updateCharts() {
            // Update usage chart based on current view
            if (usageChart) {
                let labels, data;
                const now = luxon.DateTime.now();
                
                if (state.currentView === 'day') {
                    labels = Array.from({length: 24}, (_, i) => now.startOf('day').plus({hours: i}).toJSDate());
                    data = state.hourlyHistory;
                } else if (state.currentView === 'week') {
                    labels = Array.from({length: 7}, (_, i) => now.startOf('week').plus({days: i}).toJSDate());
                    data = Array(7).fill(0).map((_, i) => Math.random() * 10 + 5); // Placeholder
                } else { // month
                    const daysInMonth = now.daysInMonth;
                    labels = Array.from({length: daysInMonth}, (_, i) => now.startOf('month').plus({days: i}).toJSDate());
                    data = Array(daysInMonth).fill(0).map((_, i) => Math.random() * 10 + 5); // Placeholder
                }
                
                usageChart.data.labels = labels;
                usageChart.data.datasets[0].data = data;
                usageChart.update();
            }

            // Update appliance chart
            if (applianceChart) {
                applianceChart.data.datasets[0].data = Object.values(state.applianceUsage).map(a => a.usage);
                applianceChart.update();
            }

            // Update gauge chart
            if (gaugeChart) {
                const budgetPercentage = Math.min(100, (state.totalUsage * state.rate) / state.budget * 100);
                gaugeChart.data.datasets[0].data = [budgetPercentage, 100 - budgetPercentage];
                gaugeChart.update();
            }

            // Update comparison chart
            if (comparisonChart) {
                const yourUsage = state.currentUsage;
                comparisonChart.data.datasets[0].data = [
                    yourUsage,
                    yourUsage * 1.3,
                    yourUsage * 0.7
                ];
                comparisonChart.update();
            }

            // Update profile usage chart
            if (profileUsageChart) {
                const months = 12;
                const now = luxon.DateTime.now();
                profileUsageChart.data.labels = Array.from({length: months}, (_, i) => 
                    now.minus({months: months - i - 1}).toJSDate());
                profileUsageChart.data.datasets[0].data = Array(months).fill(0).map(() => 
                    Math.random() * 200 + 100); // Placeholder
                profileUsageChart.update();
            }

            // Update forecast chart
            if (forecastChart) {
                const hours = 24;
                forecastChart.data.labels = Array.from({length: hours}, (_, i) => 
                    `${i}:00`);
                forecastChart.data.datasets[0].data = Array(hours).fill(0).map(() => 
                    Math.random() * 10 + 25); // Temperature
                forecastChart.data.datasets[1].data = Array(hours).fill(0).map(() => 
                    Math.random() * 2 + 0.5); // Usage
                forecastChart.update();
            }
        }

        // Update UI elements
        function updateUI() {
            // Update main dashboard values
            if (elements.currentUsage) elements.currentUsage.textContent = state.currentUsage.toFixed(2);
            if (elements.estimatedBill) elements.estimatedBill.textContent = `₹${(state.currentUsage * state.rate).toFixed(2)}`;
            if (elements.dailyAverage) elements.dailyAverage.textContent = (state.currentUsage * 24).toFixed(2);
            if (elements.rateDisplay) elements.rateDisplay.textContent = state.rate;
            if (elements.budgetLimitDisplay) elements.budgetLimitDisplay.textContent = state.budget;
            if (elements.budgetCycleDisplay) elements.budgetCycleDisplay.textContent = 
                state.cycleDays === 7 ? 'week' : 
                state.cycleDays === 15 ? 'fortnight' : 
                state.cycleDays === 30 ? 'month' : 
                state.cycleDays === 60 ? '2 months' : 'period';

            // Calculate potential savings (25% of current usage as placeholder)
            const potentialSavings = state.currentUsage * state.rate * 0.25 * 30;
            if (elements.potentialSavings) elements.potentialSavings.textContent = `₹${potentialSavings.toFixed(2)}`;

            // Update trend indicators
            if (elements.trendValue) {
                const trend = Math.random() * 20 - 10; // Random between -10% and +10%
                elements.trendValue.textContent = `${Math.abs(trend).toFixed(1)}%`;
                elements.usageTrend.className = `trend ${trend >= 0 ? 'up' : 'down'}`;
            }

            if (elements.savingsValue) {
                const savings = Math.random() * 15; // Random between 0-15%
                elements.savingsValue.textContent = `${savings.toFixed(1)}%`;
            }

            // Update carbon footprint
            if (elements.carbonFootprint) elements.carbonFootprint.textContent = state.carbonData.footprint.toFixed(1);
            if (elements.carbonEquivalent) elements.carbonEquivalent.textContent = state.carbonData.equivalent;
            if (elements.carbonSaved) elements.carbonSaved.textContent = `${state.carbonData.saved} kg`;

            // Update appliance controls
            updateApplianceControls();

            // Update history table
            updateHistoryTable();

            // Update weather forecast
            updateWeatherForecast();

            // Update charts
            updateCharts();
        }

        // Update appliance controls
        function updateApplianceControls() {
            if (!elements.applianceControls) return;
            
            elements.applianceControls.innerHTML = '';
            
            Object.entries(state.applianceUsage).forEach(([name, appliance]) => {
                const card = document.createElement('div');
                card.className = 'appliance-card';
                
                card.innerHTML = `
                    <div class="appliance-icon ${appliance.icon}"></div>
                    <div class="appliance-name">${name}</div>
                    <div class="appliance-status ${appliance.active ? '' : 'off'}">
                        ${appliance.active ? 'ON' : 'OFF'}
                    </div>
                    <div class="appliance-power">${appliance.wattage}W</div>
                    <input type="range" class="appliance-slider" min="0" max="24" value="${appliance.usage}" 
                        data-appliance="${name}">
                `;
                
                elements.applianceControls.appendChild(card);
            });
        }

        // Update history table
        function updateHistoryTable() {
            if (!elements.historyTableBody) return;
            
            elements.historyTableBody.innerHTML = '';
            
            const days = parseInt(elements.historyRange?.value) || 30;
            const now = luxon.DateTime.now();
            
            for (let i = 0; i < days; i++) {
                const date = now.minus({days: i});
                const usage = (Math.random() * 10 + 5).toFixed(2);
                const cost = (usage * state.rate).toFixed(2);
                const status = usage > 8 ? 'High' : usage < 4 ? 'Low' : 'Normal';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date.toFormat('dd LLL yyyy')}</td>
                    <td>${usage}</td>
                    <td>₹${cost}</td>
                    <td><span class="badge ${status === 'High' ? 'danger' : status === 'Low' ? 'success' : 'warning'}">${status}</span></td>
                `;
                
                elements.historyTableBody.appendChild(row);
            }
        }

        // Update weather forecast
        function updateWeatherForecast() {
            if (!elements.weatherForecast) return;
            
            elements.weatherForecast.innerHTML = '';
            
            state.weatherForecast.forEach(day => {
                const card = document.createElement('div');
                card.className = 'forecast-card';
                
                card.innerHTML = `
                    <div class="forecast-day">${day.day}</div>
                    <div class="forecast-icon ${day.icon}"></div>
                    <div class="forecast-temp">${day.temp}</div>
                    <div class="forecast-usage">~${day.usage}</div>
                `;
                
                elements.weatherForecast.appendChild(card);
            });
        }

        // Update notifications
        function updateNotifications() {
            if (!elements.notificationBadge || !elements.notificationPanel) return;
            
            const unreadCount = state.notifications.filter(n => !n.read).length;
            elements.notificationBadge.textContent = unreadCount;
            elements.notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
            
            // Update notification panel
            elements.notificationPanel.innerHTML = '';
            
            state.notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                item.innerHTML = `
                    <div>${notification.message}</div>
                    <div class="time">${luxon.DateTime.fromISO(notification.time).toRelative()}</div>
                `;
                
                item.addEventListener('click', () => {
                    notification.read = true;
                    updateNotifications();
                });
                
                elements.notificationPanel.appendChild(item);
            });
        }

        // Update user profile section
        function updateUserProfile() {
            if (!state.currentUser || !state.users[state.currentUser]) return;
            
            const user = state.users[state.currentUser];
            
            if (elements.profileName) elements.profileName.textContent = user.name;
            if (elements.profileEmail) elements.profileEmail.textContent = user.email;
            if (elements.userName) elements.userName.textContent = user.name;
            if (elements.userAvatar) elements.userAvatar.textContent = user.name.charAt(0).toUpperCase();
            if (elements.profileAvatar) elements.profileAvatar.textContent = user.name.charAt(0).toUpperCase();
            if (elements.editProfileName) elements.editProfileName.value = user.name;
            if (elements.editProfileEmail) elements.editProfileEmail.value = user.email;
            
            // Update goals
            updateGoals();
            
            // Update tariff plans
            updateTariffPlans();
        }

        // Update goals
        function updateGoals() {
            if (!elements.goalsContainer) return;
            
            elements.goalsContainer.innerHTML = '';
            
            state.goals.forEach(goal => {
                const progress = (goal.current / goal.target) * 100;
                const card = document.createElement('div');
                card.className = 'goal-card';
                
                card.innerHTML = `
                    <h3>${goal.name}</h3>
                    <div class="goal-progress">
                        <div class="goal-progress-bar" style="width: ${Math.min(100, progress)}%"></div>
                    </div>
                    <div class="goal-stats">
                        <span>${goal.current}${goal.unit}</span>
                        <span>${goal.target}${goal.unit}</span>
                    </div>
                    <div class="goal-actions">
                        <button class="btn secondary" data-goal="${goal.id}">
                            <span class="icon icon-chart"></span>
                            <span>Details</span>
                        </button>
                    </div>
                `;
                
                elements.goalsContainer.appendChild(card);
            });
        }

        // Update tariff plans
        function updateTariffPlans() {
            if (!elements.tariffPlans || !elements.currentTariffPlan) return;
            
            elements.tariffPlans.innerHTML = '';
            
            state.tariffPlans.forEach(plan => {
                const card = document.createElement('div');
                card.className = `tariff-card ${plan.recommended ? 'recommended' : ''}`;
                
                card.innerHTML = `
                    <h3>${plan.name}</h3>
                    <div class="tariff-price">${plan.price}</div>
                    <ul class="tariff-features">
                        ${plan.features.map(f => `<li>${f}</li>`).join('')}
                    </ul>
                    <div class="tariff-actions">
                        <button class="btn ${plan.current ? 'success' : 'secondary'}" data-plan="${plan.id}">
                            ${plan.current ? 'Current Plan' : 'Switch Plan'}
                        </button>
                    </div>
                `;
                
                if (plan.current) {
                    elements.currentTariffPlan.textContent = plan.name;
                }
                
                elements.tariffPlans.appendChild(card);
            });
        }

        // Translate UI elements
        function translateUI() {
            const lang = state.language || 'en';
            const translations = state.translations[lang];
            
            if (!translations) return;
            
            // Update tab labels
            if (elements.tabs) {
                elements.tabs.forEach(tab => {
                    const tabId = tab.dataset.tab;
                    if (translations[tabId]) {
                        tab.textContent = translations[tabId];
                    }
                });
            }
            
            // Update other UI elements
            if (elements.budgetAlertText) elements.budgetAlertText.textContent = translations.budgetAlert;
            if (elements.peakAlertText) elements.peakAlertText.textContent = translations.peakAlert;
            if (elements.themeToggle) {
                elements.themeToggle.innerHTML = `
                    <span class="icon ${state.darkMode ? 'icon-moon' : 'icon-sun'}"></span>
                    <span>${translations[state.darkMode ? 'darkMode' : 'lightMode']}</span>
                `;
            }
            
            // Update card titles
            const cardTitles = document.querySelectorAll('.card h2');
            cardTitles.forEach(title => {
                const icon = title.querySelector('.icon');
                const text = icon?.nextSibling?.textContent.trim();
                if (text && translations[text]) {
                    title.innerHTML = `
                        ${icon?.outerHTML || ''}
                        <span>${translations[text]}</span>
                    `;
                }
            });
            
            // Update profile section
            if (elements.editProfileBtn) {
                elements.editProfileBtn.innerHTML = `
                    <span class="icon icon-save"></span>
                    <span>${translations.editProfile}</span>
                `;
            }
            
            // Update user menu
            if (elements.profileBtn) {
                elements.profileBtn.innerHTML = `
                    <span class="icon icon-profile"></span>
                    <span>${translations.profile}</span>
                `;
            }
            
            if (elements.settingsBtn) {
                elements.settingsBtn.innerHTML = `
                    <span class="icon icon-settings"></span>
                    <span>${translations.settings}</span>
                `;
            }
            
            if (elements.logoutBtn) {
                elements.logoutBtn.innerHTML = `
                    <span class="icon icon-logout"></span>
                    <span>${translations.logout}</span>
                `;
            }
        }

        // Show dashboard
        function showDashboard() {
            if (elements.loginPage) elements.loginPage.style.display = 'none';
            if (elements.registerPage) elements.registerPage.style.display = 'none';
            if (elements.dashboard) elements.dashboard.style.display = 'block';
            
            // Initialize charts if not already done
            if (!usageChart) {
                initCharts();
            }
            
            // Start data simulation
            simulateData();
        }

        // Show login page
        function showLogin() {
            if (elements.loginPage) elements.loginPage.style.display = 'flex';
            if (elements.registerPage) elements.registerPage.style.display = 'none';
            if (elements.dashboard) elements.dashboard.style.display = 'none';
        }

        // Show register page
        function showRegister() {
            if (elements.loginPage) elements.loginPage.style.display = 'none';
            if (elements.registerPage) elements.registerPage.style.display = 'flex';
            if (elements.dashboard) elements.dashboard.style.display = 'none';
        }

        // Simulate data changes
        function simulateData() {
            // Update current usage with random variation
            const baseUsage = 0.5;
            const variation = Math.random() * 0.3 - 0.15; // -0.15 to +0.15
            state.currentUsage = Math.max(0.1, baseUsage + variation);
            
            // Update hourly history
            const now = new Date();
            const currentHour = now.getHours();
            state.hourlyHistory[currentHour] = state.currentUsage;
            
            // Update appliance usage
            Object.keys(state.applianceUsage).forEach(appliance => {
                const app = state.applianceUsage[appliance];
                if (app.active) {
                    app.usage = Math.min(24, app.usage + 0.1);
                }
            });
            
            // Update total usage for billing period
            state.totalUsage += state.currentUsage;
            
            // Check for budget alerts
            checkBudgetAlerts();
            
            // Check for peak hours
            checkPeakHours();
            
            // Update UI
            updateUI();
            
            // Schedule next update
            setTimeout(simulateData, 5000);
        }

        // Check for budget alerts
        function checkBudgetAlerts() {
            if (!elements.budgetAlert) return;
            
            const budgetPercentage = (state.totalUsage * state.rate) / state.budget * 100;
            
            if (budgetPercentage > 100) {
                elements.budgetAlert.style.display = 'block';
                elements.budgetAlert.className = 'alert danger';
            } else if (budgetPercentage > 80) {
                elements.budgetAlert.style.display = 'block';
                elements.budgetAlert.className = 'alert warning';
            } else {
                elements.budgetAlert.style.display = 'none';
            }
        }

        // Check for peak hours
        function checkPeakHours() {
            if (!elements.peakAlert) return;
            
            const now = new Date();
            const currentHour = now.getHours();
            
            if (currentHour >= state.peakStart && currentHour < state.peakEnd) {
                elements.peakAlert.style.display = 'block';
            } else {
                elements.peakAlert.style.display = 'none';
            }
        }

        // Add notification
        function addNotification(message) {
            state.notifications.unshift({
                message,
                time: new Date().toISOString(),
                read: false
            });
            
            // Keep only the last 10 notifications
            if (state.notifications.length > 10) {
                state.notifications.pop();
            }
            
            updateNotifications();
        }

        // Event Listeners
        function setupEventListeners() {
            // Login/Register events
            if (elements.showRegister) {
                elements.showRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    showRegister();
                });
            }
            
            if (elements.showLogin) {
                elements.showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    showLogin();
                });
            }
            
            if (elements.loginForm) {
                elements.loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const email = elements.loginEmail.value;
                    const password = elements.loginPassword.value;
                    
                    if (state.users[email] && state.users[email].password === password) {
                        state.currentUser = email;
                        saveState();
                        showDashboard();
                        updateUserProfile();
                        addNotification('Welcome back! Your dashboard is ready.');
                    } else {
                        alert('Invalid email or password');
                    }
                });
            }
            
            if (elements.registerForm) {
                elements.registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const name = elements.registerName.value;
                    const email = elements.registerEmail.value;
                    const password = elements.registerPassword.value;
                    const confirmPassword = elements.registerConfirmPassword.value;
                    
                    if (password !== confirmPassword) {
                        alert('Passwords do not match');
                        return;
                    }
                    
                    if (state.users[email]) {
                        alert('Email already registered');
                        return;
                    }
                    
                    state.users[email] = {
                        name,
                        email,
                        password,
                        joined: new Date().toISOString()
                    };
                    
                    state.currentUser = email;
                    saveState();
                    showDashboard();
                    updateUserProfile();
                    addNotification('Welcome! Your account has been created.');
                });
            }
            
            // Theme toggle
            if (elements.themeToggle) {
                elements.themeToggle.addEventListener('click', () => {
                    state.darkMode = !state.darkMode;
                    document.body.classList.toggle('dark-mode', state.darkMode);
                    
                    elements.themeToggle.innerHTML = `
                        <span class="icon ${state.darkMode ? 'icon-moon' : 'icon-sun'}"></span>
                        <span>${state.translations[state.language][state.darkMode ? 'darkMode' : 'lightMode']}</span>
                    `;
                    
                    saveState();
                });
            }
            
            // Settings button
            if (elements.settingsBtn) {
                elements.settingsBtn.addEventListener('click', () => {
                    elements.settingsPanel.style.display = elements.settingsPanel.style.display === 'block' ? 'none' : 'block';
                });
            }
            
            // Save settings
            if (elements.saveSettings) {
                elements.saveSettings.addEventListener('click', () => {
                    state.rate = parseFloat(elements.rateInput.value) || 5;
                    state.budget = parseFloat(elements.budgetInput.value) || 1000;
                    state.cycleDays = parseInt(elements.cycleInput.value) || 30;
                    state.peakRate = parseFloat(elements.peakRateInput.value) || 7.5;
                    
                    const peakStartTime = elements.peakStart.value.split(':');
                    state.peakStart = parseInt(peakStartTime[0]) || 14;
                    
                    const peakEndTime = elements.peakEnd.value.split(':');
                    state.peakEnd = parseInt(peakEndTime[0]) || 19;
                    
                    state.notifications = {
                        budgetAlerts: elements.budgetAlertCheck.checked,
                        peakAlerts: elements.peakAlertCheck.checked,
                        speech: elements.speechCheck.checked
                    };
                    
                    // Apply font size
                    document.body.style.fontSize = `${elements.fontSlider.value}px`;
                    
                    saveState();
                    updateUI();
                    elements.settingsPanel.style.display = 'none';
                    
                    addNotification('Settings saved successfully');
                });
            }
            
            // Notification bell
            if (elements.notificationBell) {
                elements.notificationBell.addEventListener('click', () => {
                    elements.notificationPanel.style.display = 
                        elements.notificationPanel.style.display === 'block' ? 'none' : 'block';
                });
            }
            
            // View buttons
            if (elements.viewDayBtn) {
                elements.viewDayBtn.addEventListener('click', () => {
                    state.currentView = 'day';
                    updateCharts();
                });
            }
            
            if (elements.viewWeekBtn) {
                elements.viewWeekBtn.addEventListener('click', () => {
                    state.currentView = 'week';
                    updateCharts();
                });
            }
            
            if (elements.viewMonthBtn) {
                elements.viewMonthBtn.addEventListener('click', () => {
                    state.currentView = 'month';
                    updateCharts();
                });
            }
            
            // Tabs
            if (elements.tabs) {
                elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        // Remove active class from all tabs and contents
                        elements.tabs.forEach(t => t.classList.remove('active'));
                        elements.tabContents.forEach(c => c.classList.remove('active'));
                        
                        // Add active class to clicked tab and corresponding content
                        tab.classList.add('active');
                        const tabId = tab.dataset.tab;
                        document.getElementById(`${tabId}Tab`).classList.add('active');
                    });
                });
            }
            
            // Appliance sliders (delegated event)
            if (elements.applianceControls) {
                elements.applianceControls.addEventListener('input', (e) => {
                    if (e.target.classList.contains('appliance-slider')) {
                        const appliance = e.target.dataset.appliance;
                        if (state.applianceUsage[appliance]) {
                            state.applianceUsage[appliance].usage = parseFloat(e.target.value);
                            state.applianceUsage[appliance].active = parseFloat(e.target.value) > 0;
                            updateCharts();
                        }
                    }
                });
            }
            
            // Add appliance button
            if (elements.addApplianceBtn) {
                elements.addApplianceBtn.addEventListener('click', () => {
                    elements.addApplianceModal.style.display = 'flex';
                });
            }
            
            // Close appliance modal
            if (elements.closeApplianceModal) {
                elements.closeApplianceModal.addEventListener('click', () => {
                    elements.addApplianceModal.style.display = 'none';
                });
            }
            
            // Save appliance
            if (elements.saveApplianceBtn) {
                elements.saveApplianceBtn.addEventListener('click', () => {
                    const name = elements.applianceName.value;
                    const wattage = parseFloat(elements.applianceWattage.value);
                    const usage = parseFloat(elements.applianceUsage.value);
                    
                    if (name && wattage && usage >= 0) {
                        state.applianceUsage[name] = {
                            usage,
                            wattage,
                            active: usage > 0,
                            icon: 'icon-other'
                        };
                        
                        elements.addApplianceModal.style.display = 'none';
                        updateApplianceControls();
                        updateCharts();
                        saveState();
                        
                        addNotification(`Appliance "${name}" added successfully`);
                    }
                });
            }
            
            // History range selector
            if (elements.historyRange) {
                elements.historyRange.addEventListener('change', () => {
                    updateHistoryTable();
                });
            }
            
            // Export history
            if (elements.exportHistoryBtn) {
                elements.exportHistoryBtn.addEventListener('click', () => {
                    alert('Export functionality would be implemented here');
                    addNotification('History data exported');
                });
            }
            
            // Savings tips
            if (elements.savingsTipBtn) {
                elements.savingsTipBtn.addEventListener('click', () => {
                    elements.energyTipsPanel.style.display = 'block';
                });
            }
            
            // Close tips
            if (elements.closeTipsBtn) {
                elements.closeTipsBtn.addEventListener('click', () => {
                    elements.energyTipsPanel.style.display = 'none';
                });
            }
            
            // User menu
            if (elements.userMenuBtn) {
                elements.userMenuBtn.addEventListener('click', () => {
                    elements.userMenuDropdown.classList.toggle('show');
                });
            }
            
            // Profile button
            if (elements.profileBtn) {
                elements.profileBtn.addEventListener('click', () => {
                    elements.mainDashboard.style.display = 'none';
                    elements.profileSection.style.display = 'block';
                    elements.userMenuDropdown.classList.remove('show');
                });
            }
            
            // Back to dashboard from profile
            const backButtons = document.querySelectorAll('.back-to-dashboard');
            backButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.profileSection.style.display = 'none';
                    elements.mainDashboard.style.display = 'block';
                });
            });
            
            // Logout
            if (elements.logoutBtn) {
                elements.logoutBtn.addEventListener('click', () => {
                    state.currentUser = null;
                    saveState();
                    showLogin();
                });
            }
            
            // Edit profile button
            if (elements.editProfileBtn) {
                elements.editProfileBtn.addEventListener('click', () => {
                    elements.editProfileModal.style.display = 'flex';
                });
            }
            
            // Close profile modal
            if (elements.closeProfileModal) {
                elements.closeProfileModal.addEventListener('click', () => {
                    elements.editProfileModal.style.display = 'none';
                });
            }
            
            // Save profile
            if (elements.saveProfileBtn) {
                elements.saveProfileBtn.addEventListener('click', () => {
                    const name = elements.editProfileName.value;
                    const email = elements.editProfileEmail.value;
                    const password = elements.editProfilePassword.value;
                    const confirmPassword = elements.editProfileConfirmPassword.value;
                    
                    if (password && password !== confirmPassword) {
                        alert('Passwords do not match');
                        return;
                    }
                    
                    if (state.currentUser && state.users[state.currentUser]) {
                        const user = state.users[state.currentUser];
                        user.name = name;
                        user.email = email;
                        
                        if (password) {
                            user.password = password;
                        }
                        
                        // If email changed, create new user entry
                        if (email !== state.currentUser) {
                            state.users[email] = user;
                            delete state.users[state.currentUser];
                            state.currentUser = email;
                        }
                        
                        saveState();
                        updateUserProfile();
                        elements.editProfileModal.style.display = 'none';
                        
                        addNotification('Profile updated successfully');
                    }
                });
            }
            
            // Add goal button
            if (elements.addGoalBtn) {
                elements.addGoalBtn.addEventListener('click', () => {
                    elements.addGoalModal.style.display = 'flex';
                });
            }
            
            // Close goal modal
            if (elements.closeGoalModal) {
                elements.closeGoalModal.addEventListener('click', () => {
                    elements.addGoalModal.style.display = 'none';
                });
            }
            
            // Save goal
            if (elements.saveGoalBtn) {
                elements.saveGoalBtn.addEventListener('click', () => {
                    const name = elements.goalName.value;
                    const target = parseFloat(elements.goalTarget.value);
                    const timeframe = parseInt(elements.goalTimeframe.value);
                    
                    if (name && target && timeframe) {
                        const newGoal = {
                            id: Date.now(),
                            name,
                            target,
                            current: 0,
                            timeframe,
                            unit: target > 10 ? 'kWh' : '%'
                        };
                        
                        state.goals.push(newGoal);
                        elements.addGoalModal.style.display = 'none';
                        updateGoals();
                        saveState();
                        
                        addNotification(`New goal "${name}" created`);
                    }
                });
            }
            
            // Language selector
            if (elements.languageSelect) {
                elements.languageSelect.addEventListener('change', () => {
                    state.language = elements.languageSelect.value;
                    saveState();
                    translateUI();
                });
            }
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
                
                // Close user menu if clicking outside
                if (!e.target.closest('.user-menu') && elements.userMenuDropdown) {
                    elements.userMenuDropdown.classList.remove('show');
                }
                
                // Close notification panel if clicking outside
                if (!e.target.closest('.notification-bell') && elements.notificationPanel) {
                    elements.notificationPanel.style.display = 'none';
                }
            });
        }

        // Initialize the application
        function init() {
            loadState();
            setupEventListeners();
            
            // Add some sample notifications
            if (state.notifications.length === 0) {
                addNotification('Welcome to your Smart Meter Dashboard');
                addNotification('Tip: Try adjusting your appliance usage to save energy');
            }
        }

        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
                            