<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Smart Meter Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.0.2"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --accent-color: #ff7e5f;
            --background-color: #f5f7fa;
            --text-color: #333;
            --card-bg: #fff;
            --border-color: #ddd;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
        }

        .dark-mode {
            --primary-color: #6b8cae;
            --secondary-color: #4a6fa5;
            --accent-color: #ff9a7f;
            --background-color: #121212;
            --text-color: #f0f0f0;
            --card-bg: #1e1e1e;
            --border-color: #444;
            --success-color: #388e3c;
            --warning-color: #f57c00;
            --danger-color: #d32f2f;
            --info-color: #1976d2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 32px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .theme-toggle, .language-select {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-select {
            background: var(--secondary-color);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }

        .unit {
            color: var(--secondary-color);
            font-size: 14px;
        }

        .trend {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-top: 5px;
        }

        .trend.up {
            color: var(--danger-color);
        }

        .trend.down {
            color: var(--success-color);
        }

        .trend i {
            margin-right: 5px;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 30px;
            position: relative;
        }

        .chart-container.large {
            height: 400px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button, .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button:hover, .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        button.secondary, .btn.secondary {
            background-color: var(--secondary-color);
        }

        button.danger, .btn.danger {
            background-color: var(--danger-color);
        }

        button.success, .btn.success {
            background-color: var(--success-color);
        }

        button.warning, .btn.warning {
            background-color: var(--warning-color);
        }

        select, input, textarea {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            width: 100%;
            max-width: 300px;
        }

        .alert {
            background-color: var(--warning-color);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s;
        }

        .alert.danger {
            background-color: var(--danger-color);
        }

        .alert.success {
            background-color: var(--success-color);
        }

        .alert.info {
            background-color: var(--info-color);
        }

        .settings-panel {
            display: none;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideDown 0.3s;
        }

        .settings-panel h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .gauge-container {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .notification-bell {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .notification-panel {
            position: absolute;
            right: 0;
            top: 40px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .notification-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .notification-item.unread {
            background-color: rgba(74, 111, 165, 0.1);
        }

        .notification-item .time {
            font-size: 12px;
            color: var(--secondary-color);
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .appliance-controls {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .appliance-card {
            background-color: var(--card-bg);
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .appliance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .appliance-icon {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .appliance-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .appliance-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: var(--success-color);
            color: white;
        }

        .appliance-status.off {
            background-color: var(--danger-color);
        }

        .appliance-power {
            margin-top: 5px;
            font-size: 14px;
        }

        .appliance-slider {
            width: 100%;
            margin-top: 10px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .history-table th {
            background-color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
        }

        .history-table tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            background-color: var(--secondary-color);
            color: white;
        }

        .badge.success {
            background-color: var(--success-color);
        }

        .badge.warning {
            background-color: var(--warning-color);
        }

        .badge.danger {
            background-color: var(--danger-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
        }

        .energy-tips {
            margin-top: 30px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
        }

        .energy-tips h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .tip-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
        }

        .tip-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .tip-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .progress-container {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            margin: 10px 0;
        }

        .progress-bar {
            height: 10px;
            border-radius: 10px;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        .comparison-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .comparison-card {
            flex: 1;
            min-width: 250px;
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .comparison-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .comparison-label {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .savings-card {
            background-color: var(--success-color);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .savings-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .savings-label {
            font-size: 16px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }

            .comparison-container {
                flex-direction: column;
            }

            .notification-panel {
                width: 250px;
                right: -50px;
            }
        }

        /* Icon styles (using Unicode symbols as icons) */
        .icon {
            font-style: normal;
        }
        .icon-bolt:after { content: "⚡"; }
        .icon-sun:after { content: "☀️"; }
        .icon-moon:after { content: "🌙"; }
        .icon-up:after { content: "↑"; }
        .icon-down:after { content: "↓"; }
        .icon-bell:after { content: "🔔"; }
        .icon-settings:after { content: "⚙️"; }
        .icon-chart:after { content: "📊"; }
        .icon-history:after { content: "🕒"; }
        .icon-export:after { content: "📤"; }
        .icon-reset:after { content: "🔄"; }
        .icon-tip:after { content: "💡"; }
        .icon-save:after { content: "💾"; }
        .icon-close:after { content: "✕"; }
        .icon-info:after { content: "ℹ️"; }
        .icon-warning:after { content: "⚠️"; }
        .icon-success:after { content: "✓"; }
        .icon-danger:after { content: "✗"; }
        .icon-ac:after { content: "❄️"; }
        .icon-fridge:after { content: "🍏"; }
        .icon-light:after { content: "💡"; }
        .icon-tv:after { content: "📺"; }
        .icon-other:after { content: "🔌"; }
        .icon-washing:after { content: "🧺"; }
        .icon-computer:after { content: "💻"; }
        .icon-oven:after { content: "🍳"; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="icon icon-bolt"></span>
                <span>Advanced Smart Meter</span>
            </div>
            <div class="header-controls">
                <div class="notification-bell" id="notificationBell">
                    <span class="icon icon-bell"></span>
                    <span class="notification-badge" id="notificationBadge">0</span>
                    <div class="notification-panel" id="notificationPanel"></div>
                </div>
                <select class="language-select" id="languageSelect">
                    <option value="en">English</option>
                    <option value="es">Español</option>
                    <option value="fr">Français</option>
                    <option value="de">Deutsch</option>
                </select>
                <button id="themeToggle" class="theme-toggle">
                    <span class="icon icon-sun"></span>
                    <span>Light Mode</span>
                </button>
            </div>
        </header>

        <div class="alert" id="budgetAlert">
            <span class="icon icon-warning"></span>
            <span id="budgetAlertText">Warning: You've exceeded your budget limit!</span>
        </div>

        <div class="alert info" id="peakAlert" style="display: none;">
            <span class="icon icon-info"></span>
            <span id="peakAlertText">Peak hours alert: Higher rates apply now (2pm-7pm). Consider reducing usage.</span>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2><span class="icon icon-bolt"></span> Current Usage</h2>
                <div class="value" id="currentUsage">0</div>
                <div class="unit">kWh</div>
                <div class="trend" id="usageTrend">
                    <span class="icon icon-up"></span>
                    <span id="trendValue">0%</span> from yesterday
                </div>
            </div>
            <div class="card">
                <h2><span class="icon icon-chart"></span> Estimated Bill</h2>
                <div class="value" id="estimatedBill">₹0</div>
                <div class="unit">Current rate: <span id="rateDisplay">₹5</span>/kWh</div>
                <div class="progress-container">
                    <div class="progress-bar" id="budgetProgress"></div>
                </div>
                <div class="unit">Budget: ₹<span id="budgetLimitDisplay">1000</span>/<span id="budgetCycleDisplay">month</span></div>
            </div>
            <div class="card">
                <h2><span class="icon icon-history"></span> Daily Average</h2>
                <div class="value" id="dailyAverage">0</div>
                <div class="unit">kWh/day</div>
                <div class="trend down" id="savingsTrend">
                    <span class="icon icon-down"></span>
                    <span id="savingsValue">0%</span> less than last month
                </div>
            </div>
            <div class="card">
                <h2><span class="icon icon-tip"></span> Potential Savings</h2>
                <div class="value" id="potentialSavings">₹0</div>
                <div class="unit">per month with efficiency</div>
                <button class="btn secondary" id="savingsTipBtn" style="margin-top: 10px;">
                    <span class="icon icon-tip"></span>
                    <span>Show Tips</span>
                </button>
            </div>
        </div>

        <div class="gauge-container">
            <canvas id="gaugeChart"></canvas>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="usage">Usage Analytics</div>
            <div class="tab" data-tab="appliances">Appliances</div>
            <div class="tab" data-tab="history">History</div>
            <div class="tab" data-tab="comparison">Comparison</div>
        </div>

        <div class="tab-content active" id="usageTab">
            <div class="chart-container large">
                <canvas id="usageChart"></canvas>
            </div>
            <div class="controls">
                <button id="viewDayBtn" class="secondary">
                    <span class="icon icon-sun"></span>
                    <span>Day</span>
                </button>
                <button id="viewWeekBtn" class="secondary">
                    <span class="icon icon-history"></span>
                    <span>Week</span>
                </button>
                <button id="viewMonthBtn" class="secondary">
                    <span class="icon icon-chart"></span>
                    <span>Month</span>
                </button>
                <select id="timeResolution">
                    <option value="hourly">Hourly</option>
                    <option value="30min">30 Minutes</option>
                    <option value="15min">15 Minutes</option>
                </select>
            </div>
        </div>

        <div class="tab-content" id="appliancesTab">
            <div class="appliance-controls" id="applianceControls">
                <!-- Dynamically generated -->
            </div>
            <div class="chart-container">
                <canvas id="applianceChart"></canvas>
            </div>
            <button class="btn" id="addApplianceBtn">
                <span class="icon icon-save"></span>
                <span>Add Custom Appliance</span>
            </button>
        </div>

        <div class="tab-content" id="historyTab">
            <div class="controls">
                <select id="historyRange">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
                <button class="btn secondary" id="exportHistoryBtn">
                    <span class="icon icon-export"></span>
                    <span>Export History</span>
                </button>
            </div>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Usage (kWh)</th>
                        <th>Cost (₹)</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody">
                    <!-- Dynamically generated -->
                </tbody>
            </table>
        </div>

        <div class="tab-content" id="comparisonTab">
            <div class="comparison-container">
                <div class="comparison-card">
                    <div class="comparison-label">Your Usage</div>
                    <div class="comparison-value" id="yourUsage">0 kWh</div>
                    <div class="comparison-label">Today</div>
                </div>
                <div class="comparison-card">
                    <div class="comparison-label">Neighborhood Avg</div>
                    <div class="comparison-value" id="neighborUsage">0 kWh</div>
                    <div class="comparison-label">Today</div>
                </div>
                <div class="comparison-card">
                    <div class="comparison-label">Efficient Homes</div>
                    <div class="comparison-value" id="efficientUsage">0 kWh</div>
                    <div class="comparison-label">Today</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
            <div class="savings-card">
                <div class="savings-label">Potential Savings Compared to Neighbors</div>
                <div class="savings-value" id="neighborSavings">₹0</div>
                <div class="savings-label">per month if you match efficient homes</div>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <h2><span class="icon icon-settings"></span> Settings</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="rateInput">Electricity Rate (₹/kWh)</label>
                    <input type="number" id="rateInput" step="0.01" min="0" value="5">
                </div>
                <div class="form-group">
                    <label for="budgetInput">Budget Limit (₹)</label>
                    <input type="number" id="budgetInput" min="0" value="1000">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="cycleInput">Billing Cycle</label>
                    <select id="cycleInput">
                        <option value="7">Weekly</option>
                        <option value="15">Bi-weekly</option>
                        <option value="30" selected>Monthly</option>
                        <option value="60">Bi-monthly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="peakRateInput">Peak Hours Rate (₹/kWh)</label>
                    <input type="number" id="peakRateInput" step="0.01" min="0" value="7.5">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="peakStart">Peak Hours Start</label>
                    <input type="time" id="peakStart" value="14:00">
                </div>
                <div class="form-group">
                    <label for="peakEnd">Peak Hours End</label>
                    <input type="time" id="peakEnd" value="19:00">
                </div>
            </div>
            <div class="form-group">
                <label for="fontSlider">Font Size</label>
                <input type="range" id="fontSlider" min="12" max="24" value="16">
            </div>
            <div class="form-group">
                <label for="notifications">Notifications</label>
                <div>
                    <input type="checkbox" id="budgetAlertCheck" checked>
                    <label for="budgetAlertCheck" style="display: inline;">Budget alerts</label>
                </div>
                <div>
                    <input type="checkbox" id="peakAlertCheck" checked>
                    <label for="peakAlertCheck" style="display: inline;">Peak hours alerts</label>
                </div>
                <div>
                    <input type="checkbox" id="speechCheck">
                    <label for="speechCheck" style="display: inline;">Voice notifications</label>
                </div>
            </div>
            <button id="saveSettings" class="btn success">
                <span class="icon icon-save"></span>
                <span>Save Settings</span>
            </button>
        </div>

        <div class="energy-tips" id="energyTipsPanel" style="display: none;">
            <h2><span class="icon icon-tip"></span> Energy Saving Tips</h2>
            <div class="tip-item">
                <div class="tip-title"><span class="icon icon-ac"></span> Air Conditioning</div>
                <p>Set your AC to 24°C instead of 20°C to save up to 18% on cooling costs.</p>
            </div>
            <div class="tip-item">
                <div class="tip-title"><span class="icon icon-light"></span> Lighting</div>
                <p>Switch to LED bulbs which use 75% less energy than incandescent bulbs.</p>
            </div>
            <div class="tip-item">
                <div class="tip-title"><span class="icon icon-fridge"></span> Refrigerator</div>
                <p>Keep your fridge at 3-5°C and freezer at -15°C for optimal efficiency.</p>
            </div>
            <div class="tip-item">
                <div class="tip-title"><span class="icon icon-tv"></span> Electronics</div>
                <p>Enable power saving modes on TVs and computers to reduce standby power.</p>
            </div>
            <button class="btn" id="closeTipsBtn" style="margin-top: 15px;">
                <span class="icon icon-close"></span>
                <span>Close Tips</span>
            </button>
        </div>

        <div class="modal" id="addApplianceModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Add Custom Appliance</div>
                    <div class="modal-close icon icon-close" id="closeApplianceModal"></div>
                </div>
                <div class="form-group">
                    <label for="applianceName">Appliance Name</label>
                    <input type="text" id="applianceName" placeholder="e.g., Washing Machine">
                </div>
                <div class="form-group">
                    <label for="applianceWattage">Wattage (W)</label>
                    <input type="number" id="applianceWattage" placeholder="e.g., 500">
                </div>
                <div class="form-group">
                    <label for="applianceUsage">Daily Usage (hours)</label>
                    <input type="number" id="applianceUsage" placeholder="e.g., 2" step="0.5">
                </div>
                <button class="btn success" id="saveApplianceBtn">
                    <span class="icon icon-save"></span>
                    <span>Save Appliance</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Safe DOM element selector with error handling
        function getElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.error(`Element with ID '${id}' not found`);
                return null;
            }
            return element;
        }

        // Safe event listener adder
        function addSafeListener(element, event, handler) {
            if (!element) return;
            element.addEventListener(event, handler);
        }

        // DOM Elements
        const elements = {
            currentUsage: getElement('currentUsage'),
            estimatedBill: getElement('estimatedBill'),
            budgetProgress: getElement('budgetProgress'),
            rateDisplay: getElement('rateDisplay'),
            budgetLimitDisplay: getElement('budgetLimitDisplay'),
            budgetCycleDisplay: getElement('budgetCycleDisplay'),
            budgetAlert: getElement('budgetAlert'),
            budgetAlertText: getElement('budgetAlertText'),
            peakAlert: getElement('peakAlert'),
            peakAlertText: getElement('peakAlertText'),
            dailyAverage: getElement('dailyAverage'),
            potentialSavings: getElement('potentialSavings'),
            usageTrend: getElement('usageTrend'),
            trendValue: getElement('trendValue'),
            savingsTrend: getElement('savingsTrend'),
            savingsValue: getElement('savingsValue'),
            themeToggle: getElement('themeToggle'),
            settingsBtn: getElement('settingsBtn'),
            resetBtn: getElement('resetBtn'),
            exportBtn: getElement('exportBtn'),
            viewSelect: getElement('viewSelect'),
            settingsPanel: getElement('settingsPanel'),
            rateInput: getElement('rateInput'),
            budgetInput: getElement('budgetInput'),
            cycleInput: getElement('cycleInput'),
            peakRateInput: getElement('peakRateInput'),
            peakStart: getElement('peakStart'),
            peakEnd: getElement('peakEnd'),
            fontSlider: getElement('fontSlider'),
            saveSettings: getElement('saveSettings'),
            notificationBell: getElement('notificationBell'),
            notificationBadge: getElement('notificationBadge'),
            notificationPanel: getElement('notificationPanel'),
            viewDayBtn: getElement('viewDayBtn'),
            viewWeekBtn: getElement('viewWeekBtn'),
            viewMonthBtn: getElement('viewMonthBtn'),
            timeResolution: getElement('timeResolution'),
            applianceControls: getElement('applianceControls'),
            addApplianceBtn: getElement('addApplianceBtn'),
            historyRange: getElement('historyRange'),
            exportHistoryBtn: getElement('exportHistoryBtn'),
            historyTableBody: getElement('historyTableBody'),
            yourUsage: getElement('yourUsage'),
            neighborUsage: getElement('neighborUsage'),
            efficientUsage: getElement('efficientUsage'),
            neighborSavings: getElement('neighborSavings'),
            savingsTipBtn: getElement('savingsTipBtn'),
            energyTipsPanel: getElement('energyTipsPanel'),
            closeTipsBtn: getElement('closeTipsBtn'),
            addApplianceModal: getElement('addApplianceModal'),
            closeApplianceModal: getElement('closeApplianceModal'),
            applianceName: getElement('applianceName'),
            applianceWattage: getElement('applianceWattage'),
            applianceUsage: getElement('applianceUsage'),
            saveApplianceBtn: getElement('saveApplianceBtn'),
            budgetAlertCheck: getElement('budgetAlertCheck'),
            peakAlertCheck: getElement('peakAlertCheck'),
            speechCheck: getElement('speechCheck'),
            languageSelect: getElement('languageSelect'),
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content')
        };

        // State
        let state = {
            currentUsage: 0,
            totalUsage: 0,
            rate: 5,
            peakRate: 7.5,
            peakStart: 14,
            peakEnd: 19,
            budget: 1000,
            cycleDays: 30,
            daysRemaining: 30,
            darkMode: false,
            usageHistory: {},
            hourlyHistory: Array(24).fill(0),
            dailyHistory: [],
            applianceUsage: {
                'AC': { usage: 0, wattage: 2000, active: false, icon: 'icon-ac' },
                'Refrigerator': { usage: 0, wattage: 150, active: true, icon: 'icon-fridge' },
                'Lights': { usage: 0, wattage: 100, active: false, icon: 'icon-light' },
                'TV': { usage: 0, wattage: 120, active: false, icon: 'icon-tv' },
                'Other': { usage: 0, wattage: 500, active: false, icon: 'icon-other' }
            },
            customAppliances: {},
            lastUpdate: Date.now(),
            yesterdayUsage: 0,
            lastMonthUsage: 0,
            notifications: [],
            currentTab: 'usage',
            currentView: 'day',
            language: 'en',
            translations: {
                en: {
                    budgetAlert: "Warning: You've exceeded your budget limit!",
                    peakAlert: "Peak hours alert: Higher rates apply now (2pm-7pm). Consider reducing usage.",
                    lightMode: "Light Mode",
                    darkMode: "Dark Mode",
                    currentUsage: "Current Usage",
                    estimatedBill: "Estimated Bill",
                    dailyAverage: "Daily Average",
                    potentialSavings: "Potential Savings",
                    usage: "Usage Analytics",
                    appliances: "Appliances",
                    history: "History",
                    comparison: "Comparison"
                },
                es: {
                    budgetAlert: "¡Advertencia: Ha excedido su límite de presupuesto!",
                    peakAlert: "Alerta de horas pico: Se aplican tarifas más altas ahora (2pm-7pm). Considere reducir el uso.",
                    lightMode: "Modo Claro",
                    darkMode: "Modo Oscuro",
                    currentUsage: "Uso Actual",
                    estimatedBill: "Factura Estimada",
                    dailyAverage: "Promedio Diario",
                    potentialSavings: "Ahorros Potenciales",
                    usage: "Análisis de Uso",
                    appliances: "Electrodomésticos",
                    history: "Historial",
                    comparison: "Comparación"
                },
                fr: {
                    budgetAlert: "Avertissement : Vous avez dépassé votre limite de budget !",
                    peakAlert: "Alerte heures de pointe : Des tarifs plus élevés s'appliquent maintenant (14h-19h). Envisagez de réduire l'utilisation.",
                    lightMode: "Mode Clair",
                    darkMode: "Mode Sombre",
                    currentUsage: "Utilisation Actuelle",
                    estimatedBill: "Facture Estimée",
                    dailyAverage: "Moyenne Quotidienne",
                    potentialSavings: "Économies Potentielles",
                    usage: "Analyse d'Utilisation",
                    appliances: "Appareils",
                    history: "Historique",
                    comparison: "Comparaison"
                },
                de: {
                    budgetAlert: "Warnung: Sie haben Ihr Budgetlimit überschritten!",
                    peakAlert: "Spitzenzeiten-Warnung: Höhere Tarife gelten jetzt (14-19 Uhr). Erwägen Sie, den Verbrauch zu reduzieren.",
                    lightMode: "Hellmodus",
                    darkMode: "Dunkelmodus",
                    currentUsage: "Aktueller Verbrauch",
                    estimatedBill: "Geschätzte Rechnung",
                    dailyAverage: "Tagesdurchschnitt",
                    potentialSavings: "Potenzielle Einsparungen",
                    usage: "Verbrauchsanalyse",
                    appliances: "Geräte",
                    history: "Verlauf",
                    comparison: "Vergleich"
                }
            }
        };

        // Initialize charts
        let usageChart, applianceChart, gaugeChart, comparisonChart;

        // Load state from localStorage
        function loadState() {
            const savedState = localStorage.getItem('smartMeterState');
            if (savedState) {
                const parsed = JSON.parse(savedState);
                
                // Merge with default state to ensure new properties are added
                state = {
                    ...state,
                    ...parsed,
                    lastUpdate: Date.now(), // Reset last update time
                    applianceUsage: {
                        ...state.applianceUsage,
                        ...(parsed.applianceUsage || {})
                    }
                };
                
                // Update UI with loaded values
                if (elements.rateInput) elements.rateInput.value = state.rate;
                if (elements.budgetInput) elements.budgetInput.value = state.budget;
                if (elements.cycleInput) elements.cycleInput.value = state.cycleDays;
                if (elements.peakRateInput) elements.peakRateInput.value = state.peakRate;
                if (elements.peakStart) elements.peakStart.value = `${state.peakStart.toString().padStart(2, '0')}:00`;
                if (elements.peakEnd) elements.peakEnd.value = `${state.peakEnd.toString().padStart(2, '0')}:00`;
                if (elements.budgetAlertCheck) elements.budgetAlertCheck.checked = state.notifications?.budgetAlerts !== false;
                if (elements.peakAlertCheck) elements.peakAlertCheck.checked = state.notifications?.peakAlerts !== false;
                if (elements.speechCheck) elements.speechCheck.checked = state.notifications?.speech === true;
                if (elements.languageSelect) elements.languageSelect.value = state.language || 'en';
                
                if (state.darkMode) {
                    document.body.classList.add('dark-mode');
                    if (elements.themeToggle) {
                        elements.themeToggle.innerHTML = `<span class="icon icon-moon"></span><span>${state.translations[state.language].darkMode}</span>`;
                    }
                } else if (elements.themeToggle) {
                    elements.themeToggle.innerHTML = `<span class="icon icon-sun"></span><span>${state.translations[state.language].lightMode}</span>`;
                }

                updateUI();
                updateNotifications();
                translateUI();
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('smartMeterState', JSON.stringify({
                ...state,
                lastUpdate: Date.now() // Don't save the lastUpdate to storage
            }));
        }

        // Initialize charts
        function initCharts() {
            // Usage chart (line)
            const usageCtx = document.getElementById('usageChart')?.getContext('2d');
            if (usageCtx) {
                usageChart = new Chart(usageCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Electricity Usage (kWh)',
                            data: [],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true
                        },
                        {
                            label: 'Peak Hours',
                            data: [],
                            borderColor: 'rgba(255, 99, 132, 0.5)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    displayFormats: {
                                        hour: 'HH:mm'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Usage (kWh)'
                                }
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: {
                                    box1: {
                                        type: 'box',
                                        xMin: 0,
                                        xMax: 0,
                                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                        borderColor: 'rgba(255, 99, 132, 0.5)',
                                        borderWidth: 1
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Appliance chart (pie)
            const applianceCtx = document.getElementById('applianceChart')?.getContext('2d');
            if (applianceCtx) {
                applianceChart = new Chart(applianceCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(state.applianceUsage),
                        datasets: [{
                            data: Object.values(state.applianceUsage).map(a => a.usage),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Appliance Usage Distribution'
                            }
                        }
                    }
                });
            }

            // Gauge chart
            const gaugeCtx = document.getElementById('gaugeChart')?.getContext('2d');
            if (gaugeCtx) {
                gaugeChart = new Chart(gaugeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Usage', 'Remaining'],
                        datasets: [{
                            data: [0, 100],
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            circumference: 180,
                            rotation: 270
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        }
                    }
                });
            }

            // Comparison chart
            const comparisonCtx = document.getElementById('comparisonChart')?.getContext('2d');
            if (comparisonCtx) {
                comparisonChart = new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Your Home', 'Neighborhood Avg', 'Efficient Homes'],
                        datasets: [{
                            label: 'Daily Usage (kWh)',
                            data: [0, 0, 0],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        // Update usage data
        function updateUsage() {
            const now = Date.now();
            const timeDiff = now - state.lastUpdate;
            state.lastUpdate = now;
            
            // Calculate time-based factors
            const date = new Date();
            const hour = date.getHours();
            const minute = date.getMinutes();
            const isPeakHours = hour >= state.peakStart && hour < state.peakEnd;
            
            // Show peak alert if enabled
            if (isPeakHours && elements.peakAlertCheck?.checked && !state.peakAlertShown) {
                state.peakAlertShown = true;
                if (elements.peakAlert) elements.peakAlert.style.display = 'block';
                addNotification("Peak hours started. Higher rates apply until " + state.peakEnd + ":00.", "warning");
                
                if (elements.speechCheck?.checked && window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(
                        "Peak hours have started. Electricity rates are now higher until " + state.peakEnd + " o'clock."
                    );
                    speechSynthesis.speak(utterance);
                }
            } else if (!isPeakHours && state.peakAlertShown) {
                state.peakAlertShown = false;
                if (elements.peakAlert) elements.peakAlert.style.display = 'none';
                addNotification("Peak hours ended. Normal rates now apply.", "info");
            }
            
            // Simulate usage - more during daytime and peak hours
            let usageIncrease;
            
            if (isPeakHours) {
                // Peak hours - highest usage
                usageIncrease = 0.03 + Math.random() * 0.05;
            } else if (hour >= 7 && hour < 10) {
                // Morning peak
                usageIncrease = 0.02 + Math.random() * 0.03;
            } else if (hour >= 17 && hour < 22) {
                // Evening peak
                usageIncrease = 0.03 + Math.random() * 0.04;
            } else if (hour >= 22 || hour < 6) {
                // Night - minimal usage
                usageIncrease = 0.002 + Math.random() * 0.003;
            } else {
                // Daytime
                usageIncrease = 0.01 + Math.random() * 0.02;
            }
            
            // Scale by time difference (in case tab was inactive)
            usageIncrease *= Math.min(timeDiff / 1000, 10);
            
            // Apply appliance usage
            for (const [appliance, data] of Object.entries(state.applianceUsage)) {
                if (data.active) {
                    // Calculate usage based on wattage and random factor
                    const applianceIncrease = (data.wattage / 1000) * (usageIncrease * (0.5 + Math.random())) / 10;
                    data.usage += applianceIncrease;
                    state.currentUsage += applianceIncrease;
                    state.totalUsage += applianceIncrease;
                }
            }
            
            // Add some base usage
            state.currentUsage += usageIncrease * 0.3;
            state.totalUsage += usageIncrease * 0.3;
            
            // Record hourly usage
            if (state.hourlyHistory.length <= hour) {
                state.hourlyHistory.push(0);
            }
            state.hourlyHistory[hour] += usageIncrease;
            
            // Record minute-level usage for more detailed charts
            const minuteKey = `${hour}:${Math.floor(minute / 15) * 15}`;
            if (!state.usageHistory[minuteKey]) {
                state.usageHistory[minuteKey] = 0;
            }
            state.usageHistory[minuteKey] += usageIncrease;
            
            updateUI();
            saveState();
        }

        // Update UI elements
        function updateUI() {
            // Current usage
            if (elements.currentUsage) elements.currentUsage.textContent = state.currentUsage.toFixed(2);
            
            // Calculate current rate (check if peak hours)
            const currentHour = new Date().getHours();
            const isPeakHours = currentHour >= state.peakStart && currentHour < state.peakEnd;
            const currentRate = isPeakHours ? state.peakRate : state.rate;
            
            // Estimated bill
            const estimatedBill = state.currentUsage * currentRate;
            if (elements.estimatedBill) elements.estimatedBill.textContent = `₹${estimatedBill.toFixed(2)}`;
            
            // Budget usage
            const budgetPercentage = (estimatedBill / state.budget) * 100;
            if (elements.budgetProgress) {
                elements.budgetProgress.style.width = `${Math.min(budgetPercentage, 100)}%`;
                
                // Change progress bar color based on percentage
                if (budgetPercentage > 90) {
                    elements.budgetProgress.style.backgroundColor = 'var(--danger-color)';
                } else if (budgetPercentage > 70) {
                    elements.budgetProgress.style.backgroundColor = 'var(--warning-color)';
                } else {
                    elements.budgetProgress.style.backgroundColor = 'var(--primary-color)';
                }
            }
            
            // Display rate and budget
            if (elements.rateDisplay) elements.rateDisplay.textContent = `₹${currentRate}`;
            if (elements.budgetLimitDisplay) elements.budgetLimitDisplay.textContent = state.budget;
            
            // Update cycle display text
            let cycleText = 'month';
            if (state.cycleDays <= 7) cycleText = 'week';
            else if (state.cycleDays <= 15) cycleText = 'fortnight';
            if (elements.budgetCycleDisplay) elements.budgetCycleDisplay.textContent = cycleText;
            
            // Calculate daily average
            const dailyAverage = state.totalUsage / (state.cycleDays - state.daysRemaining + 1);
            if (elements.dailyAverage) elements.dailyAverage.textContent = dailyAverage.toFixed(2);
            
            // Calculate potential savings (10-30% less than current)
            const savingsPercent = 0.1 + Math.random() * 0.2;
            const potentialSavings = estimatedBill * savingsPercent;
            if (elements.potentialSavings) elements.potentialSavings.textContent = `₹${potentialSavings.toFixed(2)}`;
            
            // Update trends
            const trendPercent = (Math.random() * 10).toFixed(1);
            if (elements.usageTrend && elements.trendValue) {
                if (Math.random() > 0.5) {
                    elements.usageTrend.className = 'trend up';
                    elements.trendValue.textContent = `${trendPercent}%`;
                } else {
                    elements.usageTrend.className = 'trend down';
                    elements.trendValue.textContent = `${trendPercent}%`;
                }
            }
            
            const savingsPercentDisplay = (Math.random() * 15).toFixed(1);
            if (elements.savingsTrend && elements.savingsValue) {
                elements.savingsTrend.className = 'trend down';
                elements.savingsValue.textContent = `${savingsPercentDisplay}%`;
            }
            
            // Check budget
            if (estimatedBill > state.budget && elements.budgetAlert && elements.budgetAlertCheck?.checked) {
                elements.budgetAlert.style.display = 'block';
                addNotification("You've exceeded your electricity budget!", "danger");
                
                // Speech alert (optional)
                if (elements.speechCheck?.checked && window.speechSynthesis && estimatedBill > state.budget * 1.05) {
                    const utterance = new SpeechSynthesisUtterance(
                        `Warning: Your electricity bill has exceeded your budget of ${state.budget} rupees.`
                    );
                    speechSynthesis.speak(utterance);
                }
            } else if (elements.budgetAlert) {
                elements.budgetAlert.style.display = 'none';
            }
            
            // Update comparison data
            updateComparisonData();
            
            // Update charts
            updateCharts();
            
            // Update appliance controls
            updateApplianceControls();
            
            // Update history table
            updateHistoryTable();
        }

        // Update comparison data
        function updateComparisonData() {
            // Simulate comparison data
            const yourUsage = state.currentUsage;
            const neighborUsage = yourUsage * (1.1 + Math.random() * 0.3); // 10-40% more
            const efficientUsage = yourUsage * (0.6 + Math.random() * 0.2); // 20-60% less
            
            if (elements.yourUsage) elements.yourUsage.textContent = `${yourUsage.toFixed(2)} kWh`;
            if (elements.neighborUsage) elements.neighborUsage.textContent = `${neighborUsage.toFixed(2)} kWh`;
            if (elements.efficientUsage) elements.efficientUsage.textContent = `${efficientUsage.toFixed(2)} kWh`;
            
            // Calculate potential savings
            const neighborSavings = (neighborUsage - yourUsage) * state.rate * 30;
            if (elements.neighborSavings) elements.neighborSavings.textContent = `₹${neighborSavings.toFixed(2)}`;
            
            // Update comparison chart
            if (comparisonChart) {
                comparisonChart.data.datasets[0].data = [yourUsage, neighborUsage, efficientUsage];
                comparisonChart.update();
            }
        }

        // Update charts
        function updateCharts() {
            // Usage chart (line)
            if (usageChart) {
                if (state.currentView === 'day') {
                    // Show today's usage by hour
                    const now = new Date();
                    const currentHour = now.getHours();
                    
                    // Generate labels for the day
                    const labels = [];
                    const data = [];
                    const peakData = [];
                    
                    for (let i = 0; i <= currentHour; i++) {
                        labels.push(new Date(now.getFullYear(), now.getMonth(), now.getDate(), i));
                        data.push(state.hourlyHistory[i] || 0);
                        peakData.push(i >= state.peakStart && i < state.peakEnd ? (data[i] || 0) : null);
                    }
                    
                    usageChart.data.labels = labels;
                    usageChart.data.datasets[0].data = data;
                    usageChart.data.datasets[1].data = peakData;
                    
                    // Update chart options for hourly view
                    usageChart.options.scales.x.time.unit = 'hour';
                    usageChart.options.scales.x.title.text = 'Hour of Day';
                } else if (state.currentView === 'week') {
                    // Show last 7 days
                    const labels = [];
                    const data = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date);
                        
                        // Simulate daily usage (for demo)
                        data.push(5 + Math.random() * 10);
                    }
                    
                    usageChart.data.labels = labels;
                    usageChart.data.datasets[0].data = data;
                    usageChart.data.datasets[1].data = []; // No peak hours in weekly view
                    
                    // Update chart options for daily view
                    usageChart.options.scales.x.time.unit = 'day';
                    usageChart.options.scales.x.title.text = 'Day';
                } else if (state.currentView === 'month') {
                    // Show last 30 days
                    const labels = [];
                    const data = [];
                    
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date);
                        
                        // Simulate daily usage (for demo)
                        data.push(5 + Math.random() * 10);
                    }
                    
                    usageChart.data.labels = labels;
                    usageChart.data.datasets[0].data = data;
                    usageChart.data.datasets[1].data = []; // No peak hours in monthly view
                    
                    // Update chart options for daily view
                    usageChart.options.scales.x.time.unit = 'day';
                    usageChart.options.scales.x.title.text = 'Day';
                }
                
                // Highlight peak hours on the chart
                const start = new Date();
                start.setHours(state.peakStart, 0, 0, 0);
                
                const end = new Date();
                end.setHours(state.peakEnd, 0, 0, 0);
                
                usageChart.options.plugins.annotation.annotations.box1.xMin = start;
                usageChart.options.plugins.annotation.annotations.box1.xMax = end;
                usageChart.update();
            }
            
            // Appliance chart (pie)
            if (applianceChart) {
                applianceChart.data.datasets[0].data = Object.values(state.applianceUsage).map(a => a.usage);
                applianceChart.update();
            }
            
            // Gauge chart
            if (gaugeChart) {
                const estimatedBill = state.currentUsage * state.rate;
                const budgetPercentage = Math.min((estimatedBill / state.budget) * 100, 100);
                gaugeChart.data.datasets[0].data = [budgetPercentage, 100 - budgetPercentage];
                gaugeChart.update();
            }
        }

        // Update appliance controls
        function updateApplianceControls() {
            if (!elements.applianceControls) return;
            
            elements.applianceControls.innerHTML = '';
            
            for (const [appliance, data] of Object.entries(state.applianceUsage)) {
                const card = document.createElement('div');
                card.className = 'appliance-card';
                
                const status = data.active ? 'on' : 'off';
                const statusClass = data.active ? '' : 'off';
                const power = (data.wattage * (data.active ? 1 : 0)).toFixed(0);
                
                card.innerHTML = `
                    <div class="appliance-icon icon ${data.icon}"></div>
                    <div class="appliance-name">${appliance}</div>
                    <div class="appliance-status ${statusClass}">${status}</div>
                    <div class="appliance-power">${power} W</div>
                    <input type="range" class="appliance-slider" min="0" max="100" value="${data.active ? 100 : 0}">
                    <button class="btn ${data.active ? 'danger' : 'success'}" data-appliance="${appliance}">
                        ${data.active ? 'Turn Off' : 'Turn On'}
                    </button>
                `;
                
                const slider = card.querySelector('.appliance-slider');
                const toggleBtn = card.querySelector('button');
                
                if (slider) {
                    slider.addEventListener('input', (e) => {
                        // For demo, just show the slider moving
                        // In a real app, this would adjust the appliance power level
                    });
                }
                
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        state.applianceUsage[appliance].active = !state.applianceUsage[appliance].active;
                        updateApplianceControls();
                        addNotification(`${appliance} turned ${state.applianceUsage[appliance].active ? 'on' : 'off'}`, 
                                       state.applianceUsage[appliance].active ? 'success' : 'info');
                    });
                }
                
                elements.applianceControls.appendChild(card);
            }
        }

        // Update history table
        function updateHistoryTable() {
            if (!elements.historyTableBody) return;
            
            elements.historyTableBody.innerHTML = '';
            
            const days = parseInt(elements.historyRange?.value || 30);
            const now = new Date();
            
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(now.getDate() - i);
                
                // Format date
                const dateStr = date.toLocaleDateString(state.language, { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                // Simulate usage data
                const usage = (3 + Math.random() * 7).toFixed(2);
                const cost = (usage * state.rate).toFixed(2);
                
                // Random status
                const statuses = ['paid', 'pending', 'overdue'];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                let statusClass = '';
                let statusText = '';
                
                if (status === 'paid') {
                    statusClass = 'success';
                    statusText = 'Paid';
                } else if (status === 'pending') {
                    statusClass = 'warning';
                    statusText = 'Pending';
                } else {
                    statusClass = 'danger';
                    statusText = 'Overdue';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${usage} kWh</td>
                    <td>₹${cost}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                `;
                
                elements.historyTableBody.appendChild(row);
            }
        }

        // Add notification
        function addNotification(message, type = 'info') {
            const notification = {
                id: Date.now(),
                message,
                type,
                time: new Date(),
                read: false
            };
            
            state.notifications.unshift(notification);
            updateNotifications();
            
            // Auto-remove old notifications
            if (state.notifications.length > 50) {
                state.notifications = state.notifications.slice(0, 50);
            }
        }

        // Update notifications UI
        function updateNotifications() {
            if (!elements.notificationBadge || !elements.notificationPanel) return;
            
            // Update badge
            const unreadCount = state.notifications.filter(n => !n.read).length;
            elements.notificationBadge.textContent = unreadCount;
            elements.notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
            
            // Update panel
            elements.notificationPanel.innerHTML = '';
            
            if (state.notifications.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'notification-item';
                empty.textContent = 'No notifications';
                elements.notificationPanel.appendChild(empty);
            } else {
                state.notifications.slice(0, 10).forEach(notification => {
                    const item = document.createElement('div');
                    item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    item.innerHTML = `
                        <div class="icon icon-${notification.type}"></div>
                        <div>${notification.message}</div>
                        <div class="time">${notification.time.toLocaleTimeString()}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        notification.read = true;
                        updateNotifications();
                    });
                    
                    elements.notificationPanel.appendChild(item);
                });
            }
        }

        // Reset usage data
        function resetUsage() {
            state.currentUsage = 0;
            state.totalUsage = 0;
            state.usageHistory = {};
            state.hourlyHistory = Array(24).fill(0);
            
            // Reset appliance usage but keep their status
            for (const appliance in state.applianceUsage) {
                state.applianceUsage[appliance].usage = 0;
            }
            
            addNotification("Usage data has been reset", "info");
            updateUI();
            saveState();
        }

        // Export data
        function exportData() {
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            csvContent += "Date,Usage (kWh),Cost (₹),Status\n";
            
            // Data (last 30 days)
            const now = new Date();
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(now.getDate() - i);
                const dateStr = date.toLocaleDateString();
                
                // Simulate data
                const usage = (3 + Math.random() * 7).toFixed(2);
                const cost = (usage * state.rate).toFixed(2);
                const status = ['paid', 'pending', 'overdue'][Math.floor(Math.random() * 3)];
                
                csvContent += `${dateStr},${usage},${cost},${status}\n`;
            }
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `electricity_usage_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addNotification("Data exported to CSV", "success");
        }

        // Translate UI
        function translateUI() {
            const lang = state.language;
            const t = state.translations[lang];
            
            // Update static text
            if (elements.budgetAlertText) elements.budgetAlertText.textContent = t.budgetAlert;
            if (elements.peakAlertText) elements.peakAlertText.textContent = t.peakAlert;
            
            // Update tab names
            document.querySelector('[data-tab="usage"]').textContent = t.usage;
            document.querySelector('[data-tab="appliances"]').textContent = t.appliances;
            document.querySelector('[data-tab="history"]').textContent = t.history;
            document.querySelector('[data-tab="comparison"]').textContent = t.comparison;
            
            // Update card titles
            const usageCardTitle = document.querySelector('#usageTab .card:nth-child(1) h2');
            const billCardTitle = document.querySelector('#usageTab .card:nth-child(2) h2');
            const avgCardTitle = document.querySelector('#usageTab .card:nth-child(3) h2');
            const savingsCardTitle = document.querySelector('#usageTab .card:nth-child(4) h2');
            
            if (usageCardTitle) usageCardTitle.innerHTML = `<span class="icon icon-bolt"></span> ${t.currentUsage}`;
            if (billCardTitle) billCardTitle.innerHTML = `<span class="icon icon-chart"></span> ${t.estimatedBill}`;
            if (avgCardTitle) avgCardTitle.innerHTML = `<span class="icon icon-history"></span> ${t.dailyAverage}`;
            if (savingsCardTitle) savingsCardTitle.innerHTML = `<span class="icon icon-tip"></span> ${t.potentialSavings}`;
        }

        // Initialize the application
        function initApp() {
            // Add safe event listeners
            addSafeListener(elements.themeToggle, 'click', () => {
                state.darkMode = !state.darkMode;
                document.body.classList.toggle('dark-mode', state.darkMode);
                
                if (state.darkMode) {
                    elements.themeToggle.innerHTML = '<span class="icon icon-moon"></span><span>' + state.translations[state.language].darkMode + '</span>';
                } else {
                    elements.themeToggle.innerHTML = '<span class="icon icon-sun"></span><span>' + state.translations[state.language].lightMode + '</span>';
                }
                
                saveState();
            });

            addSafeListener(elements.notificationBell, 'click', (e) => {
                e.stopPropagation();
                if (elements.notificationPanel) {
                    elements.notificationPanel.style.display = 
                        elements.notificationPanel.style.display === 'block' ? 'none' : 'block';
                }
            });

            document.addEventListener('click', () => {
                if (elements.notificationPanel) {
                    elements.notificationPanel.style.display = 'none';
                }
            });

            addSafeListener(elements.settingsBtn, 'click', () => {
                if (elements.settingsPanel) {
                    elements.settingsPanel.style.display = 
                        elements.settingsPanel.style.display === 'block' ? 'none' : 'block';
                }
            });

            addSafeListener(elements.saveSettings, 'click', () => {
                state.rate = parseFloat(elements.rateInput?.value || 5);
                state.peakRate = parseFloat(elements.peakRateInput?.value || 7.5);
                state.budget = parseFloat(elements.budgetInput?.value || 1000);
                state.cycleDays = parseInt(elements.cycleInput?.value || 30);
                
                // Parse peak hours
                if (elements.peakStart) {
                    const startTime = elements.peakStart.value.split(':');
                    state.peakStart = parseInt(startTime[0]);
                }
                if (elements.peakEnd) {
                    const endTime = elements.peakEnd.value.split(':');
                    state.peakEnd = parseInt(endTime[0]);
                }
                
                // Save notification preferences
                state.notifications = {
                    budgetAlerts: elements.budgetAlertCheck?.checked !== false,
                    peakAlerts: elements.peakAlertCheck?.checked !== false,
                    speech: elements.speechCheck?.checked === true
                };
                
                if (elements.settingsPanel) elements.settingsPanel.style.display = 'none';
                addNotification("Settings saved successfully", "success");
                updateUI();
                saveState();
            });

            addSafeListener(elements.resetBtn, 'click', resetUsage);
            addSafeListener(elements.exportBtn, 'click', exportData);

            addSafeListener(elements.viewDayBtn, 'click', () => {
                state.currentView = 'day';
                updateCharts();
            });

            addSafeListener(elements.viewWeekBtn, 'click', () => {
                state.currentView = 'week';
                updateCharts();
            });

            addSafeListener(elements.viewMonthBtn, 'click', () => {
                state.currentView = 'month';
                updateCharts();
            });

            addSafeListener(elements.fontSlider, 'input', (e) => {
                document.body.style.fontSize = `${e.target.value}px`;
                state.fontSize = e.target.value;
                saveState();
            });

            addSafeListener(elements.savingsTipBtn, 'click', () => {
                if (elements.energyTipsPanel) elements.energyTipsPanel.style.display = 'block';
            });

            addSafeListener(elements.closeTipsBtn, 'click', () => {
                if (elements.energyTipsPanel) elements.energyTipsPanel.style.display = 'none';
            });

            addSafeListener(elements.addApplianceBtn, 'click', () => {
                if (elements.addApplianceModal) elements.addApplianceModal.style.display = 'flex';
            });

            addSafeListener(elements.closeApplianceModal, 'click', () => {
                if (elements.addApplianceModal) elements.addApplianceModal.style.display = 'none';
            });

            addSafeListener(elements.saveApplianceBtn, 'click', () => {
                const name = elements.applianceName?.value.trim();
                const wattage = parseFloat(elements.applianceWattage?.value || 0);
                const usage = parseFloat(elements.applianceUsage?.value || 0);
                
                if (name && !isNaN(wattage) && wattage > 0) {
                    // Generate a unique key for the appliance
                    const key = name.toLowerCase().replace(/\s+/g, '_');
                    
                    // Add to custom appliances
                    state.customAppliances[key] = {
                        name,
                        wattage,
                        usage,
                        active: false,
                        icon: 'icon-other'
                    };
                    
                    // Also add to main appliance usage for tracking
                    state.applianceUsage[name] = {
                        usage: 0,
                        wattage,
                        active: false,
                        icon: 'icon-other'
                    };
                    
                    if (elements.addApplianceModal) elements.addApplianceModal.style.display = 'none';
                    if (elements.applianceName) elements.applianceName.value = '';
                    if (elements.applianceWattage) elements.applianceWattage.value = '';
                    if (elements.applianceUsage) elements.applianceUsage.value = '';
                    
                    addNotification(`Appliance "${name}" added`, "success");
                    updateApplianceControls();
                    saveState();
                }
            });

            addSafeListener(elements.languageSelect, 'change', (e) => {
                state.language = e.target.value;
                translateUI();
                saveState();
            });

            // Tab switching
            if (elements.tabs) {
                elements.tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabId = tab.getAttribute('data-tab');
                        
                        // Update active tab
                        elements.tabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Update active content
                        elements.tabContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.id === `${tabId}Tab`) {
                                content.classList.add('active');
                            }
                        });
                        
                        state.currentTab = tabId;
                    });
                });
            }

            // Initialize
            loadState();
            initCharts();
            
            // Update every 5 seconds
            setInterval(updateUsage, 5000);
            
            // Initial update
            updateUsage();
        }

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>